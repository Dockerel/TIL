<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>4. ServiceAccount와 RBAC | Today Dockerel Learned</title>
    <meta name="generator" content="VuePress 1.9.10">
    <link rel="icon" href="/TIL/logo.png">
    <meta name="description" content="Dockerel&#39;s Personal Wiki (Today I Learned)">
    
    <link rel="preload" href="/TIL/assets/css/0.styles.40dd5a95.css" as="style"><link rel="preload" href="/TIL/assets/js/app.c6b9857f.js" as="script"><link rel="preload" href="/TIL/assets/js/2.188c950f.js" as="script"><link rel="preload" href="/TIL/assets/js/1.a1e51968.js" as="script"><link rel="preload" href="/TIL/assets/js/62.9c4ed0d5.js" as="script"><link rel="prefetch" href="/TIL/assets/js/10.e6f03b60.js"><link rel="prefetch" href="/TIL/assets/js/11.0fba4bf3.js"><link rel="prefetch" href="/TIL/assets/js/12.181bd7bc.js"><link rel="prefetch" href="/TIL/assets/js/13.c5707e1c.js"><link rel="prefetch" href="/TIL/assets/js/14.b086a433.js"><link rel="prefetch" href="/TIL/assets/js/15.3e75d743.js"><link rel="prefetch" href="/TIL/assets/js/16.a2bc07a8.js"><link rel="prefetch" href="/TIL/assets/js/17.33ccdb0f.js"><link rel="prefetch" href="/TIL/assets/js/18.c240daa0.js"><link rel="prefetch" href="/TIL/assets/js/19.60958448.js"><link rel="prefetch" href="/TIL/assets/js/20.4352d5d9.js"><link rel="prefetch" href="/TIL/assets/js/21.391074bf.js"><link rel="prefetch" href="/TIL/assets/js/22.664a6cc8.js"><link rel="prefetch" href="/TIL/assets/js/23.5ae71a00.js"><link rel="prefetch" href="/TIL/assets/js/24.d267629a.js"><link rel="prefetch" href="/TIL/assets/js/25.1aeaac43.js"><link rel="prefetch" href="/TIL/assets/js/26.966808ab.js"><link rel="prefetch" href="/TIL/assets/js/27.96954a7a.js"><link rel="prefetch" href="/TIL/assets/js/28.d3b9c4c7.js"><link rel="prefetch" href="/TIL/assets/js/29.ddbd73e9.js"><link rel="prefetch" href="/TIL/assets/js/3.e9de9cb1.js"><link rel="prefetch" href="/TIL/assets/js/30.55802351.js"><link rel="prefetch" href="/TIL/assets/js/31.2ec5b8f6.js"><link rel="prefetch" href="/TIL/assets/js/32.5fd280ec.js"><link rel="prefetch" href="/TIL/assets/js/33.27f9c496.js"><link rel="prefetch" href="/TIL/assets/js/34.b322d741.js"><link rel="prefetch" href="/TIL/assets/js/35.8ed0e5c2.js"><link rel="prefetch" href="/TIL/assets/js/36.04a7ca97.js"><link rel="prefetch" href="/TIL/assets/js/37.55d41140.js"><link rel="prefetch" href="/TIL/assets/js/38.44c2873a.js"><link rel="prefetch" href="/TIL/assets/js/39.d5e34e87.js"><link rel="prefetch" href="/TIL/assets/js/4.c5b6f970.js"><link rel="prefetch" href="/TIL/assets/js/40.2fa0dc7a.js"><link rel="prefetch" href="/TIL/assets/js/41.5d4d9c9e.js"><link rel="prefetch" href="/TIL/assets/js/42.1602bec9.js"><link rel="prefetch" href="/TIL/assets/js/43.ed44001c.js"><link rel="prefetch" href="/TIL/assets/js/44.a29595e6.js"><link rel="prefetch" href="/TIL/assets/js/45.9d19a39c.js"><link rel="prefetch" href="/TIL/assets/js/46.ce0941a8.js"><link rel="prefetch" href="/TIL/assets/js/47.07bc4f54.js"><link rel="prefetch" href="/TIL/assets/js/48.f38f0bf5.js"><link rel="prefetch" href="/TIL/assets/js/49.8f7b9cd6.js"><link rel="prefetch" href="/TIL/assets/js/5.5e20f558.js"><link rel="prefetch" href="/TIL/assets/js/50.3e44bb02.js"><link rel="prefetch" href="/TIL/assets/js/51.99ae272d.js"><link rel="prefetch" href="/TIL/assets/js/52.cc562289.js"><link rel="prefetch" href="/TIL/assets/js/53.29881cda.js"><link rel="prefetch" href="/TIL/assets/js/54.2c1e7724.js"><link rel="prefetch" href="/TIL/assets/js/55.91bcf5c4.js"><link rel="prefetch" href="/TIL/assets/js/56.03d1f002.js"><link rel="prefetch" href="/TIL/assets/js/57.bd1a5145.js"><link rel="prefetch" href="/TIL/assets/js/58.72096ec4.js"><link rel="prefetch" href="/TIL/assets/js/59.bce40f9f.js"><link rel="prefetch" href="/TIL/assets/js/6.e8a6e3a8.js"><link rel="prefetch" href="/TIL/assets/js/60.5d5194ad.js"><link rel="prefetch" href="/TIL/assets/js/61.3b46f4ca.js"><link rel="prefetch" href="/TIL/assets/js/63.d79bddec.js"><link rel="prefetch" href="/TIL/assets/js/64.b1b6958d.js"><link rel="prefetch" href="/TIL/assets/js/65.24726a0c.js"><link rel="prefetch" href="/TIL/assets/js/66.a5fc8da8.js"><link rel="prefetch" href="/TIL/assets/js/7.7fea5211.js"><link rel="prefetch" href="/TIL/assets/js/vendors~docsearch.68e379d9.js">
    <link rel="stylesheet" href="/TIL/assets/css/0.styles.40dd5a95.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/TIL/" class="home-link router-link-active"><!----> <span class="site-name">Today Dockerel Learned</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="https://github.com/Dockerel/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://dockerel.tistory.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Blog
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="https://github.com/Dockerel/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://dockerel.tistory.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Blog
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Backend</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>DomainDrivenArchitecture</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Java</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>OperatingSystem</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>PS</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Kubernetes</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/TIL/Kubernetes/1.-포드,-레플리카-셋,-디플로이먼트,-서비스.html" class="sidebar-link">1.포드, 레플리카 셋, 디플로이먼트, 서비스</a></li><li><a href="/TIL/Kubernetes/2.-네임스페이스,-컨피그맵,-시크릿,-인그레스.html" class="sidebar-link">2. 네임스페이스, 컨피그맵, 시크릿, 인그레스</a></li><li><a href="/TIL/Kubernetes/3.-pv와-pvc.html" class="sidebar-link">3. PV와 PVC</a></li><li><a href="/TIL/Kubernetes/4.-ServiceAccount와-RBAC.html" class="active sidebar-link">4. ServiceAccount와 RBAC</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/TIL/Kubernetes/4.-ServiceAccount와-RBAC.html#쿠버네티스의-권한-인증-과정" class="sidebar-link">쿠버네티스의 권한 인증 과정</a></li><li class="sidebar-sub-header"><a href="/TIL/Kubernetes/4.-ServiceAccount와-RBAC.html#service-account" class="sidebar-link">Service Account</a></li><li class="sidebar-sub-header"><a href="/TIL/Kubernetes/4.-ServiceAccount와-RBAC.html#권한-부여-방법" class="sidebar-link">권한 부여 방법</a></li><li class="sidebar-sub-header"><a href="/TIL/Kubernetes/4.-ServiceAccount와-RBAC.html#쿠버네티스-api-서버-접근" class="sidebar-link">쿠버네티스 API 서버 접근</a></li><li class="sidebar-sub-header"><a href="/TIL/Kubernetes/4.-ServiceAccount와-RBAC.html#클러스터-내부에서-쿠버네티스-서비스를-통해-api-서버에-접근" class="sidebar-link">클러스터 내부에서 쿠버네티스 서비스를 통해 API 서버에 접근</a></li><li class="sidebar-sub-header"><a href="/TIL/Kubernetes/4.-ServiceAccount와-RBAC.html#쿠버네티스-sdk를-이용해-포드-내부에서-api-서버에-접근" class="sidebar-link">쿠버네티스 SDK를 이용해 포드 내부에서 API 서버에 접근</a></li><li class="sidebar-sub-header"><a href="/TIL/Kubernetes/4.-ServiceAccount와-RBAC.html#kubeconfig-파일에-서비스-어카운트-인증-정보-설정" class="sidebar-link">kubeconfig 파일에 서비스 어카운트 인증 정보 설정</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="_4-serviceaccount와-rbac"><a href="#_4-serviceaccount와-rbac" class="header-anchor">#</a> 4. ServiceAccount와 RBAC</h1> <h1 id="보안을-위한-인증과-인가"><a href="#보안을-위한-인증과-인가" class="header-anchor">#</a> 보안을 위한 인증과 인가</h1> <ul><li>여러 명의 개발자가 쿠버네티스에 접근 가능</li> <li>각 개발자가 명령어를 통해 애플리케이션을 동시에 배포할 수도 있음</li> <li>그렇게 때문에 쿠버네티스도 보안을 고려해야 함</li> <li>여러 보안 기능이 있는데, RBAC 기반 Service Account라는 기능을 가장 자주 사용</li></ul> <h2 id="쿠버네티스의-권한-인증-과정"><a href="#쿠버네티스의-권한-인증-과정" class="header-anchor">#</a> 쿠버네티스의 권한 인증 과정</h2> <p><img src="https://user-images.githubusercontent.com/47745785/154834901-ed174911-cbe7-4cda-8f29-e1b493f55a83.png" alt=""></p> <ul><li>kubectl 명령어가 실행되면 쿠버네티스 API 서버의 HTTP 핸들러에 요청 전송</li> <li>API 서버에서는 인증 및 인가 과정 진행 (Service Account 외에도 OAuth, 인증서 등과 같은 다양한 방법 사용 가능)</li> <li>그 다음에는 어드미션 컨트롤러라는 별도의 단계 처리 후 요청 받은 기능 수행
<ul><li>어드미션 컨트롤러 : 쿠버네티스 클러스터의 보안 강화 및 세부적인 정책 구현</li></ul></li></ul> <h2 id="service-account"><a href="#service-account" class="header-anchor">#</a> Service Account</h2> <ul><li>체계적으로 권한을 관리하기 위한 쿠버네티스 오브젝트</li></ul> <div class="language-bash extra-class"><pre class="language-bash"><code>dgh0001@rpi4b:~$ kubectl get sa
NAME      SECRETS   AGE
default   <span class="token number">0</span>         72d

dgh0001@rpi4b:~$ kubectl get serviceaccount
NAME      SECRETS   AGE
default   <span class="token number">0</span>         72d
</code></pre></div><ul><li>사용자 또는 애플리케이션 하나에 해당</li> <li>RBAC라는 기능을 통해 특정 명령을 실행할 수 있는 권한을 서비스 어카운트에 부여</li> <li>권한을 부여받은 서비스 어카운트는 해당 권한에 해당하는 기능만 사용할 수 있음</li></ul> <div class="language-bash extra-class"><pre class="language-bash"><code>dgh0001@rpi4b:~$ kubectl get svc
NAME         TYPE        CLUSTER-IP   EXTERNAL-IP   PORT<span class="token punctuation">(</span>S<span class="token punctuation">)</span>   AGE
kubernetes   ClusterIP   <span class="token number">10.43</span>.0.1    <span class="token operator">&lt;</span>none<span class="token operator">&gt;</span>        <span class="token number">443</span>/TCP   28d

dgh0001@rpi4b:~$ kubectl get svc <span class="token parameter variable">--as</span> system:serviceaccount:default:temp
Error from server <span class="token punctuation">(</span>Forbidden<span class="token punctuation">)</span>: services is forbidden: User <span class="token string">&quot;system:serviceaccount:default:temp&quot;</span> cannot list resource <span class="token string">&quot;services&quot;</span> <span class="token keyword">in</span> API group <span class="token string">&quot;&quot;</span> <span class="token keyword">in</span> the namespace <span class="token string">&quot;default&quot;</span>
</code></pre></div><ul><li>기본적으로는 <code>~/.kube/config</code>라는 파일에 설정된 인증 정보를 통해 쿠버네티스 클러스터를 제어</li> <li>두 번째 커맨드와 같이 <code>--as</code>로 임시 서비스 어카운트를 사용하여 kubectl 명령어를 실행하면 권한 오류 발생</li></ul> <ul><li>적절한 권한을 부여해야만 쿠버네티스 기능 사용 가능</li></ul> <h2 id="권한-부여-방법"><a href="#권한-부여-방법" class="header-anchor">#</a> 권한 부여 방법</h2> <ul><li>Role(네임스페이스에 속함), Cluster Role(네임스페이스에 속하지 않음)</li></ul> <h3 id="role"><a href="#role" class="header-anchor">#</a> Role</h3> <ul><li>부여할 권한이 무엇인지를 나타내는 쿠버네티스 오브젝트
<ul><li>디플로이먼트를 생성 가능하다, 서비스 목록을 조회한다 등</li></ul></li> <li><code>kubectl get role</code></li> <li>service-reader-role.yaml</li></ul> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Role
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default
  <span class="token key atrule">name</span><span class="token punctuation">:</span> service<span class="token punctuation">-</span>reader
<span class="token key atrule">rules</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;&quot;</span><span class="token punctuation">]</span> <span class="token comment"># 대상이 될 오브젝트의 API 그룹</span>
    <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;services&quot;</span><span class="token punctuation">]</span> <span class="token comment"># 대상이 될 오브젝트의 이름</span>
    <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;get&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;list&quot;</span><span class="token punctuation">]</span> <span class="token comment"># 어떠한 동작을 허용할 것인지 명시</span>
</code></pre></div><h4 id="apigroups"><a href="#apigroups" class="header-anchor">#</a> apiGroups</h4> <ul><li>쿠버네티스의 오브젝트가 가지는 목적에 따라 분류되는 일종의 카테고리</li> <li><code>kubectl api-resources</code>로 확인 가능 (APIVERSION 칼럼의 [APIGROUP]/[VERSION])</li></ul> <div class="language-bash extra-class"><pre class="language-bash"><code>dgh0001@rpi4b:~$ kubectl api-resources
NAME                                SHORTNAMES   APIVERSION                          NAMESPACED   KIND
pods                                po           v1                                  <span class="token boolean">true</span>         Pod
services                            svc          v1                                  <span class="token boolean">true</span>         Service
deployments                         deploy       apps/v1                             <span class="token boolean">true</span>         Deployment
</code></pre></div><ul><li>현재 서비스는 코어 API 그룹에 속하기 때문에 apiGroup이 없음</li></ul> <h4 id="resources"><a href="#resources" class="header-anchor">#</a> resources</h4> <ul><li>어떤 쿠버네티스 오브젝트에 대해 권한을 정의할 것인지</li></ul> <h4 id="verbs"><a href="#verbs" class="header-anchor">#</a> verbs</h4> <ul><li>이 롤을 부여받은 대상이 resources에 지정된 오브젝트들에 대해 어떤 동작을 수행할 수 있는지 정의</li></ul> <h3 id="rolebinding"><a href="#rolebinding" class="header-anchor">#</a> RoleBinding</h3> <ul><li>이렇게 만들어진 롤을 특정 대상에게 부여하려면 Role Binding이라는 오브젝트를 통해 특정 대상과 롤을 연결해야 함</li></ul> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> RoleBinding
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> service<span class="token punctuation">-</span>reader<span class="token punctuation">-</span>rolebinding
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default
<span class="token key atrule">subjects</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount <span class="token comment"># 권한을 부여할 대상이 ServiceAccount임</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> temp <span class="token comment"># temp라는 이름을 가진 서비스 어카운트에 권한 부여</span>
    <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default
<span class="token key atrule">roleRef</span><span class="token punctuation">:</span>
  <span class="token key atrule">kind</span><span class="token punctuation">:</span> Role <span class="token comment"># Role에 정의된 권한 부여</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> service<span class="token punctuation">-</span>reader <span class="token comment"># service-reader라는 이름의 Role을 대상에 연결</span>
  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io
</code></pre></div><ul><li>롤 바인딩 적용 후</li></ul> <div class="language-yaml extra-class"><pre class="language-yaml"><code>dgh0001@rpi4b<span class="token punctuation">:</span>~$ kubectl apply <span class="token punctuation">-</span>f rolebinding<span class="token punctuation">-</span>service<span class="token punctuation">-</span>reader.yaml
rolebinding.rbac.authorization.k8s.io/service<span class="token punctuation">-</span>reader<span class="token punctuation">-</span>rolebinding created

dgh0001@rpi4b<span class="token punctuation">:</span>~$ kubectl get svc <span class="token punctuation">-</span><span class="token punctuation">-</span>as system<span class="token punctuation">:</span>serviceaccount<span class="token punctuation">:</span>default<span class="token punctuation">:</span>temp
NAME         TYPE        CLUSTER<span class="token punctuation">-</span>IP   EXTERNAL<span class="token punctuation">-</span>IP   PORT(S)   AGE
kubernetes   ClusterIP   10.43.0.1    &lt;none<span class="token punctuation">&gt;</span>        443/TCP   28d
</code></pre></div><ul><li>서비스 목록을 조회하는 권한을 부여받았기 때문에 정상적으로 명령어 사용 가능</li></ul> <h3 id="cluster-role"><a href="#cluster-role" class="header-anchor">#</a> Cluster Role</h3> <ul><li>클러스터 단위의 권한을 정의할 때 사용</li> <li>여러 네임스페이스에서 사용되는 권한을 클러스터 롤로 만들어 쓸 수 있음</li> <li><code>kubectl get clusterrole</code></li> <li>롤을 사용할 때 처럼 클러스터 롤도 클러스터 롤 바인딩이라는 쿠버네티스 오브젝트를 사용해야 함</li></ul> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nodes<span class="token punctuation">-</span>reader
<span class="token key atrule">rules</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">apiGroups</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;&quot;</span><span class="token punctuation">]</span>
    <span class="token key atrule">resources</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;nodes&quot;</span><span class="token punctuation">]</span>
    <span class="token key atrule">verbs</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;get&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;list&quot;</span><span class="token punctuation">]</span>

<span class="token punctuation">---</span>
<span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> rbac.authorization.k8s.io/v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRoleBinding
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nodes<span class="token punctuation">-</span>reader<span class="token punctuation">-</span>clusterrolebinding
  <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default
<span class="token key atrule">subjects</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">kind</span><span class="token punctuation">:</span> ServiceAccount
    <span class="token key atrule">name</span><span class="token punctuation">:</span> temp
    <span class="token key atrule">namespace</span><span class="token punctuation">:</span> default
<span class="token key atrule">roleRef</span><span class="token punctuation">:</span>
  <span class="token key atrule">kind</span><span class="token punctuation">:</span> ClusterRole
  <span class="token key atrule">name</span><span class="token punctuation">:</span> nodes<span class="token punctuation">-</span>reader
  <span class="token key atrule">apiGroup</span><span class="token punctuation">:</span> rbac.authorization.k8s.io
</code></pre></div><ul><li>클러스터 롤 생성 및 바인딩 후</li></ul> <div class="language-bash extra-class"><pre class="language-bash"><code>dgh0001@rpi4b:~$ kubectl apply <span class="token parameter variable">-f</span> nodes-reader-clusterrole.yaml
clusterrole.rbac.authorization.k8s.io/nodes-reader created

dgh0001@rpi4b:~$ kubectl apply <span class="token parameter variable">-f</span> clusterrolebinding-nodes-reader.yaml
clusterrolebinding.rbac.authorization.k8s.io/nodes-reader-clusterrolebinding created

dgh0001@rpi4b:~$ kubectl get nodes <span class="token parameter variable">--as</span> system:serviceaccount:default:temp
NAME    STATUS   ROLES                  AGE   VERSION
rpi4b   Ready    control-plane,master   72d   v1.33.4+k3s1
</code></pre></div><ul><li>정상적으로 실행 가능</li></ul> <h2 id="쿠버네티스-api-서버-접근"><a href="#쿠버네티스-api-서버-접근" class="header-anchor">#</a> 쿠버네티스 API 서버 접근</h2> <ul><li>쿠버네티스 API 서버도 HTTP 요청을 통해 쿠버네티스 기능 사용 가능</li></ul> <div class="language-bash extra-class"><pre class="language-bash"><code>dgh0001@rpi4b:~$ <span class="token function">curl</span> https://localhost:6443/apis <span class="token parameter variable">-k</span>
<span class="token punctuation">{</span>
  <span class="token string">&quot;kind&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;Status&quot;</span>,
  <span class="token string">&quot;apiVersion&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;v1&quot;</span>,
  <span class="token string">&quot;metadata&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>,
  <span class="token string">&quot;status&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;Failure&quot;</span>,
  <span class="token string">&quot;message&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;Unauthorized&quot;</span>,
  <span class="token string">&quot;reason&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;Unauthorized&quot;</span>,
  <span class="token string">&quot;code&quot;</span><span class="token builtin class-name">:</span> <span class="token number">401</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>하지만 일반적인 방식으로는 권한 부족으로 접근 불가능</li> <li>별도의 인증 정보를 HTTP 페이로드에 포함시켜야 함</li></ul> <div class="language-bash extra-class"><pre class="language-bash"><code>dgh0001@rpi4b:~$ kubectl create token temp
<span class="token punctuation">..</span>.

dgh0001@rpi4b:~$ <span class="token function">curl</span> https://localhost:6443/apis <span class="token parameter variable">--header</span> <span class="token string">&quot;Authorization: Bearer ...&quot;</span> <span class="token parameter variable">-k</span>
<span class="token punctuation">{</span>
  <span class="token string">&quot;kind&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;APIGroupList&quot;</span>,
  <span class="token string">&quot;apiVersion&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;v1&quot;</span>,
  <span class="token string">&quot;groups&quot;</span><span class="token builtin class-name">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
</code></pre></div><h2 id="클러스터-내부에서-쿠버네티스-서비스를-통해-api-서버에-접근"><a href="#클러스터-내부에서-쿠버네티스-서비스를-통해-api-서버에-접근" class="header-anchor">#</a> 클러스터 내부에서 쿠버네티스 서비스를 통해 API 서버에 접근</h2> <ul><li>쿠버네티스에 기본적으로 존재하고 있는 kubernetes라는 이름의 서비스를 통해 API 사용</li></ul> <h2 id="쿠버네티스-sdk를-이용해-포드-내부에서-api-서버에-접근"><a href="#쿠버네티스-sdk를-이용해-포드-내부에서-api-서버에-접근" class="header-anchor">#</a> 쿠버네티스 SDK를 이용해 포드 내부에서 API 서버에 접근</h2> <p><img src="https://user-images.githubusercontent.com/47745785/156710112-57a7c69a-aefe-4090-ae61-34d32afac982.png" alt=""></p> <ul><li>포드 내부에서 실행되는 어플리케이션의 경우 특정 언어로 바인딩 된 쿠버네티스 SDK 방식으로도 API 서버에 접근 가능</li></ul> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">try</span><span class="token punctuation">:</span>
    kubernetes<span class="token punctuation">.</span>config<span class="token punctuation">.</span>load_kube_config<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">except</span> kubernetes<span class="token punctuation">.</span>config<span class="token punctuation">.</span>config_exception<span class="token punctuation">.</span>ConfigException<span class="token punctuation">:</span>
    logging<span class="token punctuation">.</span>warning<span class="token punctuation">(</span><span class="token string">&quot;Failed to load kubeconfig.&quot;</span><span class="token punctuation">)</span>
    exit<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>

api_client <span class="token operator">=</span> kubernetes<span class="token punctuation">.</span>client<span class="token punctuation">.</span>CoreV1Api<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="kubeconfig-파일에-서비스-어카운트-인증-정보-설정"><a href="#kubeconfig-파일에-서비스-어카운트-인증-정보-설정" class="header-anchor">#</a> kubeconfig 파일에 서비스 어카운트 인증 정보 설정</h2> <ul><li>kubectl 명령어를 통해 쿠버네티스 클러스터를 제어할 때는 kubeconfig라는 파일을 통해 인증 진행</li> <li>크게 clusters, users, contexts로 이루어져 있음
<ul><li>clusters : 쿠버네티스 API 서버의 접속 정보 목록</li> <li>users : 쿠버네티스 API 서버에 접속하기 위한 사용자 인증 정보 목록</li> <li>contexts: cluster와 users를 조합해 컨텍스트 정의 (ex. cluster A에 user a로 인증해 쿠버네티스 사용)</li></ul></li></ul></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/TIL/Kubernetes/3.-pv와-pvc.html" class="prev">
        3. PV와 PVC
      </a></span> <!----></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/TIL/assets/js/app.c6b9857f.js" defer></script><script src="/TIL/assets/js/2.188c950f.js" defer></script><script src="/TIL/assets/js/1.a1e51968.js" defer></script><script src="/TIL/assets/js/62.9c4ed0d5.js" defer></script>
  </body>
</html>
