<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>3. 애그리거트 | Today Dockerel Learned</title>
    <meta name="generator" content="VuePress 1.9.10">
    <link rel="icon" href="/TIL/logo.png">
    <meta name="description" content="Dockerel&#39;s Personal Wiki (Today I Learned)">
    
    <link rel="preload" href="/TIL/assets/css/0.styles.40dd5a95.css" as="style"><link rel="preload" href="/TIL/assets/js/app.6782ab33.js" as="script"><link rel="preload" href="/TIL/assets/js/2.188c950f.js" as="script"><link rel="preload" href="/TIL/assets/js/1.a1e51968.js" as="script"><link rel="preload" href="/TIL/assets/js/49.1afdf71d.js" as="script"><link rel="prefetch" href="/TIL/assets/js/10.e6f03b60.js"><link rel="prefetch" href="/TIL/assets/js/11.0fba4bf3.js"><link rel="prefetch" href="/TIL/assets/js/12.181bd7bc.js"><link rel="prefetch" href="/TIL/assets/js/13.c5707e1c.js"><link rel="prefetch" href="/TIL/assets/js/14.b086a433.js"><link rel="prefetch" href="/TIL/assets/js/15.3e75d743.js"><link rel="prefetch" href="/TIL/assets/js/16.a2bc07a8.js"><link rel="prefetch" href="/TIL/assets/js/17.cdeb945d.js"><link rel="prefetch" href="/TIL/assets/js/18.c240daa0.js"><link rel="prefetch" href="/TIL/assets/js/19.60958448.js"><link rel="prefetch" href="/TIL/assets/js/20.4352d5d9.js"><link rel="prefetch" href="/TIL/assets/js/21.0860caab.js"><link rel="prefetch" href="/TIL/assets/js/22.664a6cc8.js"><link rel="prefetch" href="/TIL/assets/js/23.5ae71a00.js"><link rel="prefetch" href="/TIL/assets/js/24.acc80ca6.js"><link rel="prefetch" href="/TIL/assets/js/25.1aeaac43.js"><link rel="prefetch" href="/TIL/assets/js/26.023e1766.js"><link rel="prefetch" href="/TIL/assets/js/27.41f28bb0.js"><link rel="prefetch" href="/TIL/assets/js/28.37ba8758.js"><link rel="prefetch" href="/TIL/assets/js/29.630c9aec.js"><link rel="prefetch" href="/TIL/assets/js/3.e9de9cb1.js"><link rel="prefetch" href="/TIL/assets/js/30.4a6e8d59.js"><link rel="prefetch" href="/TIL/assets/js/31.01be341e.js"><link rel="prefetch" href="/TIL/assets/js/32.5fd280ec.js"><link rel="prefetch" href="/TIL/assets/js/33.27f9c496.js"><link rel="prefetch" href="/TIL/assets/js/34.c2abcd24.js"><link rel="prefetch" href="/TIL/assets/js/35.8ed0e5c2.js"><link rel="prefetch" href="/TIL/assets/js/36.e65cfcdf.js"><link rel="prefetch" href="/TIL/assets/js/37.07950455.js"><link rel="prefetch" href="/TIL/assets/js/38.9411f06d.js"><link rel="prefetch" href="/TIL/assets/js/39.95d679c7.js"><link rel="prefetch" href="/TIL/assets/js/4.c5b6f970.js"><link rel="prefetch" href="/TIL/assets/js/40.b2083cd5.js"><link rel="prefetch" href="/TIL/assets/js/41.7de67450.js"><link rel="prefetch" href="/TIL/assets/js/42.c90d510f.js"><link rel="prefetch" href="/TIL/assets/js/43.e3589587.js"><link rel="prefetch" href="/TIL/assets/js/44.4c2532fb.js"><link rel="prefetch" href="/TIL/assets/js/45.09b01ef3.js"><link rel="prefetch" href="/TIL/assets/js/46.a4526624.js"><link rel="prefetch" href="/TIL/assets/js/47.4fdfcdf3.js"><link rel="prefetch" href="/TIL/assets/js/48.873d6a99.js"><link rel="prefetch" href="/TIL/assets/js/5.5e20f558.js"><link rel="prefetch" href="/TIL/assets/js/50.77bc39d9.js"><link rel="prefetch" href="/TIL/assets/js/51.ac3c70be.js"><link rel="prefetch" href="/TIL/assets/js/52.d7e88570.js"><link rel="prefetch" href="/TIL/assets/js/53.b5e0078a.js"><link rel="prefetch" href="/TIL/assets/js/54.63442310.js"><link rel="prefetch" href="/TIL/assets/js/55.e25e9470.js"><link rel="prefetch" href="/TIL/assets/js/56.d55b5ccf.js"><link rel="prefetch" href="/TIL/assets/js/57.cf962fab.js"><link rel="prefetch" href="/TIL/assets/js/58.a01582ba.js"><link rel="prefetch" href="/TIL/assets/js/59.2b2e1bfd.js"><link rel="prefetch" href="/TIL/assets/js/6.e8a6e3a8.js"><link rel="prefetch" href="/TIL/assets/js/60.933fc59f.js"><link rel="prefetch" href="/TIL/assets/js/61.651dfcc4.js"><link rel="prefetch" href="/TIL/assets/js/62.e097350c.js"><link rel="prefetch" href="/TIL/assets/js/63.6845d699.js"><link rel="prefetch" href="/TIL/assets/js/64.c8934f45.js"><link rel="prefetch" href="/TIL/assets/js/65.cce0c2b8.js"><link rel="prefetch" href="/TIL/assets/js/66.7c616de9.js"><link rel="prefetch" href="/TIL/assets/js/67.7bfe15fc.js"><link rel="prefetch" href="/TIL/assets/js/68.0e452e3b.js"><link rel="prefetch" href="/TIL/assets/js/69.5aaf7a09.js"><link rel="prefetch" href="/TIL/assets/js/7.7fea5211.js"><link rel="prefetch" href="/TIL/assets/js/70.b9555da5.js"><link rel="prefetch" href="/TIL/assets/js/71.70c3db82.js"><link rel="prefetch" href="/TIL/assets/js/72.d8285789.js"><link rel="prefetch" href="/TIL/assets/js/vendors~docsearch.68e379d9.js">
    <link rel="stylesheet" href="/TIL/assets/css/0.styles.40dd5a95.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/TIL/" class="home-link router-link-active"><!----> <span class="site-name">Today Dockerel Learned</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="https://github.com/Dockerel/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://dockerel.tistory.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Blog
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="https://github.com/Dockerel/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://dockerel.tistory.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Blog
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Backend</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>DomainDrivenArchitecture</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/TIL/DomainDrivenArchitecture/1.-도메인-모델-시작하기.html" class="sidebar-link">1. 도메인 모델 시작하기</a></li><li><a href="/TIL/DomainDrivenArchitecture/2.-아키텍처-개요.html" class="sidebar-link">2. 아키텍처 개요</a></li><li><a href="/TIL/DomainDrivenArchitecture/3.-애그리거트.html" class="active sidebar-link">3. 애그리거트</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/TIL/DomainDrivenArchitecture/3.-애그리거트.html#_3-1-애그리거트" class="sidebar-link">3.1 애그리거트</a></li><li class="sidebar-sub-header"><a href="/TIL/DomainDrivenArchitecture/3.-애그리거트.html#_3-2-애그리거트-루트" class="sidebar-link">3.2 애그리거트 루트</a></li><li class="sidebar-sub-header"><a href="/TIL/DomainDrivenArchitecture/3.-애그리거트.html#_3-3-리포지터리와-애그리거트" class="sidebar-link">3.3 리포지터리와 애그리거트</a></li><li class="sidebar-sub-header"><a href="/TIL/DomainDrivenArchitecture/3.-애그리거트.html#_3-4-id를-이용한-애그리거트-참조" class="sidebar-link">3.4 ID를 이용한 애그리거트 참조</a></li><li class="sidebar-sub-header"><a href="/TIL/DomainDrivenArchitecture/3.-애그리거트.html#_3-5-애그리거트-간-집합-연관" class="sidebar-link">3.5 애그리거트 간 집합 연관</a></li><li class="sidebar-sub-header"><a href="/TIL/DomainDrivenArchitecture/3.-애그리거트.html#_3-6-애그리거트를-팩토리로-사용하기" class="sidebar-link">3.6 애그리거트를 팩토리로 사용하기</a></li></ul></li><li><a href="/TIL/DomainDrivenArchitecture/4.-리포지터리와-모델-구현.html" class="sidebar-link">4. 리포지터리와 모델 구현</a></li><li><a href="/TIL/DomainDrivenArchitecture/5.-스프링-데이터-JPA를-이용한-조회-기능.html" class="sidebar-link">5. 스프링 데이터 JPA를 이용한 조회 기능</a></li><li><a href="/TIL/DomainDrivenArchitecture/6.-응용-서비스와-표현-영역.html" class="sidebar-link">6. 응용 서비스와 표현 영역</a></li><li><a href="/TIL/DomainDrivenArchitecture/7.-도메인-서비스.html" class="sidebar-link">7. 도메인 서비스</a></li><li><a href="/TIL/DomainDrivenArchitecture/8.-애그리거트-트랜잭션-관리.html" class="sidebar-link">8. 애그리거트 트랜잭션 관리</a></li><li><a href="/TIL/DomainDrivenArchitecture/9.-도메인-모델과-경계.html" class="sidebar-link">9. 도메인 모델과 경계</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Java</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>OperatingSystem</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>PS</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Kubernetes</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="_3-애그리거트"><a href="#_3-애그리거트" class="header-anchor">#</a> 3. 애그리거트</h1> <h2 id="_3-1-애그리거트"><a href="#_3-1-애그리거트" class="header-anchor">#</a> 3.1 애그리거트</h2> <ul><li>상위 수준에서 모델을 정리하면 복잡한 도메인 모델을 이해하는데 도움이 됨</li> <li>개별 객체 수준에서 모델을 바라보면 관계 파악이 어려움 → 코드 변경 및 확장이 어려움</li></ul> <p>애그리거트란 <strong>상위 수준에서 모델을 조망</strong>하는 방법</p> <ul><li>애그리거트에 속한 구성요소는 대부분 함께 생성하고 함께 제거</li> <li>애그리거트는 경계를 가짐 → 한 애그리거트에 속한 개체는 다른 애그리거트에 속하지 않음</li></ul> <h3 id="애그리거트-경계-설정-시"><a href="#애그리거트-경계-설정-시" class="header-anchor">#</a> 애그리거트 경계 설정 시</h3> <ul><li>도메인 규칙과 요구사항</li> <li>도메인 규칙에 따라 함께 생성되는 구성요소는 한 애그리거트에 속할 가능성이 높음</li> <li>ex) 주문할 상품 개수, 배송지 정보, 주문자 정보</li> <li>A가 B를 가질 때 A와 B는 같은 애그리거트에 속한다 → X</li> <li>ex) 상품 - 리뷰. 상품 상세에 들어갔을 때 리뷰를 같이 보여줘야 한다면 한 애그리거트에 속한다고 생각할 수 있지만 product와 review는 함께 생성되지도 않고 함께 변경되지도 않는다</li></ul> <h2 id="_3-2-애그리거트-루트"><a href="#_3-2-애그리거트-루트" class="header-anchor">#</a> 3.2 애그리거트 루트</h2> <p>애그리거트는 여러 객체로 구성되기 때문에 도메인 규칙을 지키려면 애그리거트에 속한 모든 객체가 정상 상태를 가져야 함</p> <ul><li>애그리거트 전체를 관리할 주체 → 애그리거트의 루트 엔티티 (애그리거트의 대표 엔티티
)
<img src="https://velog.velcdn.com/images/csh0034/post/9eb0370b-506b-4721-a8d5-571f813845a0/image.png" alt=""></li></ul> <h3 id="_3-2-1-도메인-규칙과-일관성"><a href="#_3-2-1-도메인-규칙과-일관성" class="header-anchor">#</a> 3.2.1 도메인 규칙과 일관성</h3> <ul><li>애그리거트 루트의 핵심 역할은 애그리거트의 일관성이 깨지지 않도록 하는 것
→ 애그리거트가 제공해야 할 도메인 기능 구현</li> <li>애그리거트 내부에서만 에그리거트에 속한 객체를 변경할 수 있도록</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Order</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">ShippingInfo</span> shippingInfo<span class="token punctuation">;</span>

    <span class="token comment">// 의미가 드러나는 메서드명 사용</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">changeShippingInfo</span><span class="token punctuation">(</span><span class="token class-name">ShippingInfo</span> newShippingInfo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">verifyNotYetShipped</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">setShippingInfo</span><span class="token punctuation">(</span>newShippingInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// set 메서드는 private로</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">setShippingInfo</span><span class="token punctuation">(</span><span class="token class-name">ShippingInfo</span> newShippingInfo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>shippingInfo <span class="token operator">=</span> newShippingInfo<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>애그리거트 외부에서 내부 상태를 함부로 바꾸지 못하므로 일관성이 깨질 가능성이 줄어듦</li></ul> <h3 id="애그리거트-루트의-기능-구현"><a href="#애그리거트-루트의-기능-구현" class="header-anchor">#</a> 애그리거트 루트의 기능 구현</h3> <ul><li>애그리거트 루트는 내부의 다른 객체들을 조합해서 기능 완성</li> <li>ex) Order는 총 주문금액을 완성하기 위해 OrderLine 목록 사용</li> <li>상태 참조 or 상태 변경 위임</li></ul> <h4 id="상태-변경-위임-예시"><a href="#상태-변경-위임-예시" class="header-anchor">#</a> 상태 변경 위임 예시</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderLines</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderLines</span><span class="token punctuation">&gt;</span></span> lines<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">Money</span> <span class="token function">getTotalAmounts</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">changeOrderLines</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ORderLine</span><span class="token punctuation">&gt;</span></span> newLines<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>lines <span class="token operator">=</span> newLines<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Order</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token class-name">OrderLines</span> orderLines<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">changeOrderLines</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderLine</span><span class="token punctuation">&gt;</span></span> newLines<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        orderLines<span class="token punctuation">.</span><span class="token function">changeOrderLines</span><span class="token punctuation">(</span>newLines<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>totalAmounts <span class="token operator">=</span> orderLines<span class="token punctuation">.</span><span class="token function">getTotalAmounts</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>근데 이렇게 하면 totalAmount를 계산하지 않는 버그가 생길 수도 있음</li> <li>해겳법은 애그리거트 외부에서 OrderLine 목록을 변경할 수 없도록 불변 (final, setter 없음, protected 등)로 구성</li></ul> <h3 id="_3-2-3-트랜잭션-범위"><a href="#_3-2-3-트랜잭션-범위" class="header-anchor">#</a> 3.2.3 트랜잭션 범위</h3> <ul><li>한 트랜잭션에서 한 애그리거트만 수정</li> <li>애그리거트에서 다른 애그리거트를 변경하지 않음</li> <li>부득이하게 한 트랜잭션으로 두 개 이상의 애그리거트를 수정해야 한다면 응용 서비스에서 두 애그리거트를 수정하도록 구현</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ChangeOrderService</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Transactional</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">changeShippingInfo</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Order</span> order <span class="token operator">=</span> orderRepository<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>order <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">OrderNotFoundException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        order<span class="token punctuation">.</span><span class="token function">shipTo</span><span class="token punctuation">(</span>newShippingInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>useNewShippingAddrAsMemberAddr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            order<span class="token punctuation">.</span><span class="token function">getOrderer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getCustomer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">changeAddress</span><span class="token punctuation">(</span>newShippingInfo<span class="token punctuation">.</span><span class="token function">getAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>도메인 이벤트로 한 애그리거트를 수정하면서 다른 애그리거트의 상태를 변경할 수도 있음</li></ul> <h4 id="한-트랜잭션에서-두-개-이상의-애그리거트를-수정하는-경우"><a href="#한-트랜잭션에서-두-개-이상의-애그리거트를-수정하는-경우" class="header-anchor">#</a> 한 트랜잭션에서 두 개 이상의 애그리거트를 수정하는 경우</h4> <ul><li>응용 서비스의 기능을 한 트랜잭션으로 실행해야 하는 경우</li> <li>기술적으로 이벤트 방식을 도입할 수 없는 경우</li> <li>운영ㅇ의 편리함을 위해 한 트랜잭션에서 여러 애그리거트의 상태 변경</li></ul> <h2 id="_3-3-리포지터리와-애그리거트"><a href="#_3-3-리포지터리와-애그리거트" class="header-anchor">#</a> 3.3 리포지터리와 애그리거트</h2> <ul><li>리포지터리는 애그리거트 단위로 존재</li></ul> <blockquote><p>Q. P.112에 JPA에서 밸류 타입을 매핑할 때 사용하는 @Component 라는데 @Embaddable 아님?</p></blockquote> <ul><li>애그리거트 저장 시 해당 애그리거트에 속한 모든 구성요소를 포함해야 함</li> <li>그렇지 않으면 기능 실행 도중 문제가 발생할 수도 있음</li></ul> <h2 id="_3-4-id를-이용한-애그리거트-참조"><a href="#_3-4-id를-이용한-애그리거트-참조" class="header-anchor">#</a> 3.4 ID를 이용한 애그리거트 참조</h2> <ul><li>한 애그리거트 루트가 다른 애그리거트 루트를 참조 가능</li> <li>근데 ORM 기술 사용 시 여러 문제가 생길 수 있음</li></ul> <ol><li>다른 애그리거트에 쉽게 접근할 수 있으므로 다른 애그리거트를 수정하고자 하는 유혹에 빠지기 쉬움 → 다른 애그리거트에 대해 의존 결합도를 높임</li> <li>성능과 관련된 여러가지 고민이 생김</li> <li>서비스가 커지면서 도메인별로 시스템을 분리하기 어려워짐
→ <strong>ID를 이용해서 다른 애드리거트를 참조하도록</strong> <img src="https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&amp;fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdna%2FbZAnDJ%2FbtrDWJ0Pdcv%2FAAAAAAAAAAAAAAAAAAAAAJb1Jk7QJiPlI4136plUS5303lYixSflAYx0hST5fayD%2Fimg.png%3Fcredential%3DyqXZFxpELC7KVnFOS48ylbz2pIh7yKj8%26expires%3D1756652399%26allow_ip%3D%26allow_referer%3D%26signature%3DnHcjq5AGX8px3EKagQjleiNNHbo%253D" alt=""></li></ol> <ul><li>애그리거트의 경계를 명확히 하고</li> <li>애그리거트 간 물리적인 연결을 제거 → 모델의 복잡도를 낮춤</li> <li>애그리거트 간 의존 제거 → 응집도를 높히는 효과</li> <li>구현 복잡도도 낮아짐 → 필요하면 응용 서비스에서 ID를 이용해서 로딩</li></ul> <h3 id="_3-4-1-id를-이용한-참조와-조회-성능"><a href="#_3-4-1-id를-이용한-참조와-조회-성능" class="header-anchor">#</a> 3.4.1 ID를 이용한 참조와 조회 성능</h3> <ul><li>애그리거트 참조로 N+1 조회문제가 생길 수 있음</li> <li>조회 전용 쿼리 사용으로 해결 가능</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Repository</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JpaOrderViewDao</span> <span class="token keyword">implements</span> <span class="token class-name">OrderViewDao</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@PersistenceContext</span>
    <span class="token keyword">private</span> <span class="token class-name">EntityManager</span> em<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderView</span><span class="token punctuation">&gt;</span></span> <span class="token function">selectByOrder</span><span class="token punctuation">(</span><span class="token class-name">String</span> ordererId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> selectQuery <span class="token operator">=</span>
            <span class="token string">&quot;select new com.myshop.order.application.dto.OrderView(o, m, p) &quot;</span> <span class="token operator">+</span>
            <span class="token string">&quot;from Order o join o.orderLines ol, Member m, Product p &quot;</span> <span class="token operator">+</span>
            <span class="token string">&quot;where o.orderer.memberId.id = :ordererId &quot;</span> <span class="token operator">+</span>
            <span class="token string">&quot;and o.orderer.memberId = m.id &quot;</span> <span class="token operator">+</span>
            <span class="token string">&quot;and ol.productId = p.id &quot;</span> <span class="token operator">+</span>
            <span class="token string">&quot;order by o.number.number desc&quot;</span><span class="token punctuation">;</span>

        <span class="token class-name">TypedQuery</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderView</span><span class="token punctuation">&gt;</span></span> query <span class="token operator">=</span>
            em<span class="token punctuation">.</span><span class="token function">createQuery</span><span class="token punctuation">(</span>selectQuery<span class="token punctuation">,</span> <span class="token class-name">OrderView</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        query<span class="token punctuation">.</span><span class="token function">setParameter</span><span class="token punctuation">(</span><span class="token string">&quot;ordererId&quot;</span><span class="token punctuation">,</span> ordererId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> query<span class="token punctuation">.</span><span class="token function">getResultList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>애그리거트마다 다른 저장소를 사용하여 한번에 로드하지 못하는 경우 → 조회 성능을 높히기 위해 캐시를 도입하거나 조회 전용 저장소를 따로 구성</li></ul> <h2 id="_3-5-애그리거트-간-집합-연관"><a href="#_3-5-애그리거트-간-집합-연관" class="header-anchor">#</a> 3.5 애그리거트 간 집합 연관</h2> <ul><li>성능 문제가 발생할 수 있기 때문에 애그리거트간 연관이 있더라도 실제 구현에 반영하지 않을 수 있음</li> <li>n-m 관계에서도 상품-카테고리 관계에 대해 상품에서 카테고리로의 단방향만 적용</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Entity</span>
<span class="token annotation punctuation">@Table</span><span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">&quot;product&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Product</span><span class="token punctuation">{</span>
	<span class="token annotation punctuation">@EmbeddedId</span>
	<span class="token keyword">private</span> <span class="token class-name">ProductId</span> id<span class="token punctuation">;</span>
	
	<span class="token annotation punctuation">@ElementCollection</span>
	<span class="token annotation punctuation">@CollectionTable</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;product_category&quot;</span><span class="token punctuation">,</span>
						joinColumns <span class="token operator">=</span> <span class="token annotation punctuation">@JoinColumn</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;product_id&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token keyword">private</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CategoryId</span><span class="token punctuation">&gt;</span></span> categoryIds<span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>Q. 이러면 그럼 테이블이 product, category, product_category 이렇게 있는데 product-product_category 이렇게만 연결해서 쓰는 느낌이고 category는 연결 안된 느낌?</p></blockquote> <h2 id="_3-6-애그리거트를-팩토리로-사용하기"><a href="#_3-6-애그리거트를-팩토리로-사용하기" class="header-anchor">#</a> 3.6 애그리거트를 팩토리로 사용하기</h2> <ul><li>한 애그리거트를 다른 애그리거트를 생성하는 팩토리 역할로도 사용 가능</li> <li>ex) Store 애그리거트에서 Product 생성할 수 있는 상태(차단 여부 등)인지 확인 후 Product 애그리거트 생성</li> <li>애그리거트가 갖고 있는 데이터를 사용해서 다른 애그리거트를 생성해야 한다면 애그리거트에 팩토리 메서드를 구현하는 것 고려해보기</li> <li>혹은 다른 정보가 너무 많이 필요하다면 또 다른 팩토리에 위임도 가능</li></ul> <blockquote><p>Q. 그럼 위임한걸 또 위임해도 됨? 예를 들어서 store에서 업로그 가능한지 확인 후 category로 위임해서 category 팩토리에서 생성</p></blockquote></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/TIL/DomainDrivenArchitecture/2.-아키텍처-개요.html" class="prev">
        2. 아키텍처 개요
      </a></span> <span class="next"><a href="/TIL/DomainDrivenArchitecture/4.-리포지터리와-모델-구현.html">
        4. 리포지터리와 모델 구현
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/TIL/assets/js/app.6782ab33.js" defer></script><script src="/TIL/assets/js/2.188c950f.js" defer></script><script src="/TIL/assets/js/1.a1e51968.js" defer></script><script src="/TIL/assets/js/49.1afdf71d.js" defer></script>
  </body>
</html>
