<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>4. 리포지터리와 모델 구현 | Today Dockerel Learned</title>
    <meta name="generator" content="VuePress 1.9.10">
    <link rel="icon" href="/TIL/logo.png">
    <meta name="description" content="Dockerel&#39;s Personal Wiki (Today I Learned)">
    
    <link rel="preload" href="/TIL/assets/css/0.styles.40dd5a95.css" as="style"><link rel="preload" href="/TIL/assets/js/app.8603dc01.js" as="script"><link rel="preload" href="/TIL/assets/js/2.188c950f.js" as="script"><link rel="preload" href="/TIL/assets/js/1.a1e51968.js" as="script"><link rel="preload" href="/TIL/assets/js/47.899377b1.js" as="script"><link rel="prefetch" href="/TIL/assets/js/10.e6f03b60.js"><link rel="prefetch" href="/TIL/assets/js/11.0fba4bf3.js"><link rel="prefetch" href="/TIL/assets/js/12.181bd7bc.js"><link rel="prefetch" href="/TIL/assets/js/13.c5707e1c.js"><link rel="prefetch" href="/TIL/assets/js/14.b086a433.js"><link rel="prefetch" href="/TIL/assets/js/15.3e75d743.js"><link rel="prefetch" href="/TIL/assets/js/16.a2bc07a8.js"><link rel="prefetch" href="/TIL/assets/js/17.5d7303c4.js"><link rel="prefetch" href="/TIL/assets/js/18.c240daa0.js"><link rel="prefetch" href="/TIL/assets/js/19.60958448.js"><link rel="prefetch" href="/TIL/assets/js/20.4352d5d9.js"><link rel="prefetch" href="/TIL/assets/js/21.1d0c9094.js"><link rel="prefetch" href="/TIL/assets/js/22.664a6cc8.js"><link rel="prefetch" href="/TIL/assets/js/23.5ae71a00.js"><link rel="prefetch" href="/TIL/assets/js/24.e765f507.js"><link rel="prefetch" href="/TIL/assets/js/25.1aeaac43.js"><link rel="prefetch" href="/TIL/assets/js/26.a623edfb.js"><link rel="prefetch" href="/TIL/assets/js/27.fc7bcf44.js"><link rel="prefetch" href="/TIL/assets/js/28.3e1d9905.js"><link rel="prefetch" href="/TIL/assets/js/29.4ed97b30.js"><link rel="prefetch" href="/TIL/assets/js/3.e9de9cb1.js"><link rel="prefetch" href="/TIL/assets/js/30.b1407afd.js"><link rel="prefetch" href="/TIL/assets/js/31.cd1b8abc.js"><link rel="prefetch" href="/TIL/assets/js/32.474f9200.js"><link rel="prefetch" href="/TIL/assets/js/33.4c3a3b6d.js"><link rel="prefetch" href="/TIL/assets/js/34.b322d741.js"><link rel="prefetch" href="/TIL/assets/js/35.4f98b8f2.js"><link rel="prefetch" href="/TIL/assets/js/36.15e8adcb.js"><link rel="prefetch" href="/TIL/assets/js/37.047ad3c2.js"><link rel="prefetch" href="/TIL/assets/js/38.7f6a188b.js"><link rel="prefetch" href="/TIL/assets/js/39.15632cb6.js"><link rel="prefetch" href="/TIL/assets/js/4.c5b6f970.js"><link rel="prefetch" href="/TIL/assets/js/40.c6e43dac.js"><link rel="prefetch" href="/TIL/assets/js/41.3e66a26f.js"><link rel="prefetch" href="/TIL/assets/js/42.22eaeb85.js"><link rel="prefetch" href="/TIL/assets/js/43.a789992a.js"><link rel="prefetch" href="/TIL/assets/js/44.5bf1992c.js"><link rel="prefetch" href="/TIL/assets/js/45.f97bfe63.js"><link rel="prefetch" href="/TIL/assets/js/46.620194e5.js"><link rel="prefetch" href="/TIL/assets/js/48.2337a549.js"><link rel="prefetch" href="/TIL/assets/js/49.a9548446.js"><link rel="prefetch" href="/TIL/assets/js/5.5e20f558.js"><link rel="prefetch" href="/TIL/assets/js/50.b01eeb2c.js"><link rel="prefetch" href="/TIL/assets/js/51.45759ab4.js"><link rel="prefetch" href="/TIL/assets/js/52.59db2f99.js"><link rel="prefetch" href="/TIL/assets/js/53.0e5b9499.js"><link rel="prefetch" href="/TIL/assets/js/54.e4ec105b.js"><link rel="prefetch" href="/TIL/assets/js/55.0d77b7e9.js"><link rel="prefetch" href="/TIL/assets/js/56.0f98103b.js"><link rel="prefetch" href="/TIL/assets/js/57.9730e12a.js"><link rel="prefetch" href="/TIL/assets/js/58.6279eb41.js"><link rel="prefetch" href="/TIL/assets/js/59.7e11d030.js"><link rel="prefetch" href="/TIL/assets/js/6.e8a6e3a8.js"><link rel="prefetch" href="/TIL/assets/js/60.bc36b034.js"><link rel="prefetch" href="/TIL/assets/js/61.42343254.js"><link rel="prefetch" href="/TIL/assets/js/7.7fea5211.js"><link rel="prefetch" href="/TIL/assets/js/vendors~docsearch.68e379d9.js">
    <link rel="stylesheet" href="/TIL/assets/css/0.styles.40dd5a95.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/TIL/" class="home-link router-link-active"><!----> <span class="site-name">Today Dockerel Learned</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="https://github.com/Dockerel/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://dockerel.tistory.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Blog
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="https://github.com/Dockerel/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://dockerel.tistory.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Blog
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Backend</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>DomainDrivenArchitecture</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/TIL/DomainDrivenArchitecture/1.-도메인-모델-시작하기.html" class="sidebar-link">1. 도메인 모델 시작하기</a></li><li><a href="/TIL/DomainDrivenArchitecture/2.-아키텍처-개요.html" class="sidebar-link">2. 아키텍처 개요</a></li><li><a href="/TIL/DomainDrivenArchitecture/3.-애그리거트.html" class="sidebar-link">3. 애그리거트</a></li><li><a href="/TIL/DomainDrivenArchitecture/4.-리포지터리와-모델-구현.html" class="active sidebar-link">4. 리포지터리와 모델 구현</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/TIL/DomainDrivenArchitecture/4.-리포지터리와-모델-구현.html#_4-1-jpa를-이용한-리포지터리-구현" class="sidebar-link">4.1 JPA를 이용한 리포지터리 구현</a></li><li class="sidebar-sub-header"><a href="/TIL/DomainDrivenArchitecture/4.-리포지터리와-모델-구현.html#_4-2-스프링-데이터-jpa를-이요한-리포지터리-구현" class="sidebar-link">4.2 스프링 데이터 JPA를 이요한 리포지터리 구현</a></li><li class="sidebar-sub-header"><a href="/TIL/DomainDrivenArchitecture/4.-리포지터리와-모델-구현.html#_4-3-매핑-구현" class="sidebar-link">4.3 매핑 구현</a></li><li class="sidebar-sub-header"><a href="/TIL/DomainDrivenArchitecture/4.-리포지터리와-모델-구현.html#_4-4-애그리거트-로딩-전략" class="sidebar-link">4.4 애그리거트 로딩 전략</a></li><li class="sidebar-sub-header"><a href="/TIL/DomainDrivenArchitecture/4.-리포지터리와-모델-구현.html#_4-5-애그리거트의-영속성-전파" class="sidebar-link">4.5 애그리거트의 영속성 전파</a></li><li class="sidebar-sub-header"><a href="/TIL/DomainDrivenArchitecture/4.-리포지터리와-모델-구현.html#_4-6-식별자-생성-기능" class="sidebar-link">4.6 식별자 생성 기능</a></li><li class="sidebar-sub-header"><a href="/TIL/DomainDrivenArchitecture/4.-리포지터리와-모델-구현.html#_4-7-도메인-구현과-dip" class="sidebar-link">4.7 도메인 구현과 DIP</a></li></ul></li><li><a href="/TIL/DomainDrivenArchitecture/5.-스프링-데이터-JPA를-이용한-조회-기능.html" class="sidebar-link">5. 스프링 데이터 JPA를 이용한 조회 기능</a></li><li><a href="/TIL/DomainDrivenArchitecture/6.-응용-서비스와-표현-영역.html" class="sidebar-link">6. 응용 서비스와 표현 영역</a></li><li><a href="/TIL/DomainDrivenArchitecture/7.-도메인-서비스.html" class="sidebar-link">7. 도메인 서비스</a></li><li><a href="/TIL/DomainDrivenArchitecture/8.-애그리거트-트랜잭션-관리.html" class="sidebar-link">8. 애그리거트 트랜잭션 관리</a></li><li><a href="/TIL/DomainDrivenArchitecture/9.-도메인-모델과-경계.html" class="sidebar-link">9. 도메인 모델과 경계</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Java</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>OperatingSystem</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>PS</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="_4-리포지터리와-모델-구현"><a href="#_4-리포지터리와-모델-구현" class="header-anchor">#</a> 4. 리포지터리와 모델 구현</h1> <h2 id="_4-1-jpa를-이용한-리포지터리-구현"><a href="#_4-1-jpa를-이용한-리포지터리-구현" class="header-anchor">#</a> 4.1 JPA를 이용한 리포지터리 구현</h2> <h3 id="_4-1-1-모듈-위치"><a href="#_4-1-1-모듈-위치" class="header-anchor">#</a> 4.1.1 모듈 위치</h3> <p><img src="https://heeveloper.github.io/img/DDDStart/4-repository-module.png" alt=""></p> <ul><li>리포지터리 인터페이스는 도메인 영역에, 구현체는 인프라스트럭처 영역에</li> <li>→ 인프라스트럭처에 대한 의존 ↓</li></ul> <h3 id="_4-1-2-리포지터리-기본-기능-구현"><a href="#_4-1-2-리포지터리-기본-기능-구현" class="header-anchor">#</a> 4.1.2 리포지터리 기본 기능 구현</h3> <ul><li>인터페이스는 애그리거트 루트를 기준으로 작성</li> <li>삭제 기능 : 관리자 페이지에서 삭제한 데이터 조회해야 하는 경우, 데이터 원복을 위해 일정 기간동안 데이터를 보관해야 하는 경우 등을 고려하여 삭제 기능 실행 시 바로 삭제하기 보다는 삭제 플래그를 사용해서 화면에 보여줄지 여부 결정
<ul><li>찾아보니 삭제한 데이터 보관용 테이블을 만드는 경우도 있었음 → 다 같은 테이블에 두는 것보다 조회 성능이 더 좋을듯</li></ul></li></ul> <h2 id="_4-2-스프링-데이터-jpa를-이요한-리포지터리-구현"><a href="#_4-2-스프링-데이터-jpa를-이요한-리포지터리-구현" class="header-anchor">#</a> 4.2 스프링 데이터 JPA를 이요한 리포지터리 구현</h2> <p>-</p> <h2 id="_4-3-매핑-구현"><a href="#_4-3-매핑-구현" class="header-anchor">#</a> 4.3 매핑 구현</h2> <h3 id="_4-3-1-엔티티와-밸류-기본-매핑-구현"><a href="#_4-3-1-엔티티와-밸류-기본-매핑-구현" class="header-anchor">#</a> 4.3.1 엔티티와 밸류 기본 매핑 구현</h3> <ul><li>애그리거트 루트는 엔티티이므로 <code>@Entity</code>로 매핑 설정</li> <li>밸류는 <code>@Embeddable</code>, 밸류 타입 프로퍼티는 <code>@Embedded</code>로 매핑 설정</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Entity</span> <span class="token comment">// 루트 엔티티 Order</span>
<span class="token annotation punctuation">@Tagble</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;purchase_order&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Order</span> <span class="token punctuation">{</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
	<span class="token annotation punctuation">@Embedded</span>
	<span class="token class-name">Orderer</span> orderer<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Embeddable</span> <span class="token comment">//Order의 밸류</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Orderer</span> <span class="token punctuation">{</span>
	<span class="token annotation punctuation">@Embedded</span>
	<span class="token annotation punctuation">@AttributeOverrides</span><span class="token punctuation">(</span> <span class="token comment">//MemberId에 정의되어있는 컬럼의 이름을 변경하기 위해 사용</span>
		<span class="token annotation punctuation">@AttributeOverride</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;id&quot;</span><span class="token punctuation">,</span> column <span class="token operator">=</span> <span class="token annotation punctuation">@Column</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;orderer_id&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">)</span>
	<span class="token keyword">private</span> <span class="token class-name">MemberId</span> memberId<span class="token punctuation">;</span>
	<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Entity</span> <span class="token comment">// Order의 밸류 타입 프로퍼티</span>
<span class="token annotation punctuation">@Table</span><span class="token punctuation">(</span>name<span class="token operator">=</span><span class="token string">&quot;purchase_order&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Order</span> <span class="token punctuation">{</span>
	<span class="token annotation punctuation">@Embedded</span>
	<span class="token keyword">private</span> <span class="token class-name">Orderer</span> orderer<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>Orderer 클래스가 <code>밸류</code>, Order 객체 내의 orderer 필드는 <code>밸류 타입 프로퍼티</code></li></ul> <h3 id="_4-3-2-기본-생성자"><a href="#_4-3-2-기본-생성자" class="header-anchor">#</a> 4.3.2 기본 생성자</h3> <ul><li>JPA에서 @Entity와 @Embeddable로 클래스를 매핑하려면 기본 생성자를 제공해야 함
<ul><li>다른 클래스에서 온전하지 못한 객체를 만들지 못하게 하기 위해 <code>protected</code>로 선언</li></ul></li></ul> <h3 id="_4-3-3-필드-접근-방식-사용"><a href="#_4-3-3-필드-접근-방식-사용" class="header-anchor">#</a> 4.3.3 필드 접근 방식 사용</h3> <ul><li>프로퍼티 방식으로 JPA 매핑을 처리하면 쓸대없는 getter/setter를 추가해야 함</li> <li>꼭 필드처리로 필요한 get 메서드 그리고 cancel(), changeShippingInfo() 등 도메인 기능을 구현하도록 하자</li> <li>@Access 어노테이션을 명시하지 않더라도 @Id나 @EmbeddedId 어노테이션이 필드에 있으면 필드 접근 방식이 자동으로 선택됨</li> <li>어그리거트 루트에서만 설정되면 되고 밸류 객체들에는 따로 @Id나 @EmbeddedId 어노테이션 필요없음</li></ul> <h3 id="_4-3-4-attributeconverter를-이용한-밸류-매핑-처리"><a href="#_4-3-4-attributeconverter를-이용한-밸류-매핑-처리" class="header-anchor">#</a> 4.3.4 AttributeConverter를 이용한 밸류 매핑 처리</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Length</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> value<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> unit<span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>해당 객체를 100cm로 저장하고 싶으면? → AttributeConverter 사용</li> <li>밸류 타입과 칼럼 데이터 간의 변환을 처리하기 위한 기능 정의</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Converter</span><span class="token punctuation">(</span>autoApply <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LengthConverter</span> <span class="token keyword">implements</span> <span class="token class-name">AttributeConverter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Length</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">convertToDatabaseColumn</span><span class="token punctuation">(</span><span class="token class-name">Length</span> length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> length <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>length<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; &quot;</span> <span class="token operator">+</span> length<span class="token punctuation">.</span><span class="token function">getUnit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Length</span> <span class="token function">convertToEntityAttribute</span><span class="token punctuation">(</span><span class="token class-name">String</span> dbData<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>dbData <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> dbDatas <span class="token operator">=</span> dbData<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot; &quot;</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Length</span><span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>dbDatas<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> dbDatas<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>@Converter의 autoApply 속성을 false로 지정하면 프로퍼티 값을 변환할 때 사용할 컨버터 직접 지정</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Product</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Column</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;product_length&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@Convert</span><span class="token punctuation">(</span>converter <span class="token operator">=</span> <span class="token class-name">LengthConverter</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">Length</span> productLength<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_4-3-5-밸류-컬렉션-별도-테이블-매핑"><a href="#_4-3-5-밸류-컬렉션-별도-테이블-매핑" class="header-anchor">#</a> 4.3.5 밸류 컬렉션 : 별도 테이블 매핑</h3> <ul><li>밸류 컬렉션을 따로 테이블로 매핑할 수도 있음</li></ul> <p><img src="https://velog.velcdn.com/images/alstjr971/post/9d9198a0-61a8-4550-b6f4-15369d554df0/image.png" alt=""></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Entity</span>
<span class="token annotation punctuation">@Table</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;purchase_order&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Order</span> <span class="token punctuation">{</span>
	<span class="token annotation punctuation">@EmbeddedId</span>
    <span class="token keyword">private</span> <span class="token class-name">OrderNo</span> number<span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token annotation punctuation">@ElementCollection</span><span class="token punctuation">(</span>fetch <span class="token operator">=</span> <span class="token class-name">FetchType</span><span class="token punctuation">.</span><span class="token constant">EAGER</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@CollectionTable</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;order_line&quot;</span><span class="token punctuation">,</span>
    	joinColumns <span class="token operator">=</span> <span class="token annotation punctuation">@JoinColumn</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;order_number&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@OrderColumn</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;line_idx&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderLine</span><span class="token punctuation">&gt;</span></span> orderLines<span class="token punctuation">;</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Embeddable</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderLine</span> <span class="token punctuation">{</span>
	<span class="token annotation punctuation">@Embedded</span>
    <span class="token keyword">private</span> <span class="token class-name">ProductId</span> productId<span class="token punctuation">;</span>
    
    <span class="token annotation punctuation">@Column</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;price&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">Money</span> price<span class="token punctuation">;</span>
    
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>Q. 한번에 필요하면 모르겠는데 이렇게 하면 일단 N+1 문제 발생하지 않나?</p></blockquote> <h3 id="_4-3-6-밸류-컬렉션-한-개-칼럼-매핑"><a href="#_4-3-6-밸류-컬렉션-한-개-칼럼-매핑" class="header-anchor">#</a> 4.3.6 밸류 컬렉션 : 한 개 칼럼 매핑</h3> <ul><li>AttributeConverter 사용</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EmailSet</span> <span class="token punctuation">{</span>
	<span class="token keyword">private</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Email</span><span class="token punctuation">&gt;</span></span> emails <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">public</span> <span class="token class-name">EmailSet</span><span class="token punctuation">(</span><span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Email</span><span class="token punctuation">&gt;</span></span> emails<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    	<span class="token keyword">this</span><span class="token punctuation">.</span>emails<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>emails<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">public</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Email</span><span class="token punctuation">&gt;</span></span> <span class="token function">getEmails</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    	<span class="token keyword">return</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">unmodifiableSet</span><span class="token punctuation">(</span>emails<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EmailSetConverter</span> <span class="token keyword">implements</span> <span class="token class-name">AttributeConverter</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">EmailSet</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

	<span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">convertToDatabaseDolumn</span><span class="token punctuation">(</span><span class="token class-name">EmailSet</span> attribute<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    	<span class="token keyword">if</span><span class="token punctuation">(</span>attribute <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> attribute<span class="token punctuation">.</span><span class="token function">getEmails</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        	<span class="token function">map</span><span class="token punctuation">(</span>email <span class="token operator">-&gt;</span> email<span class="token punctuation">.</span><span class="token function">getAddress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">joining</span><span class="token punctuation">(</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">EmailSet</span> <span class="token function">convertToEntityAttribute</span><span class="token punctuation">(</span><span class="token class-name">String</span> dbData<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    	<span class="token keyword">if</span><span class="token punctuation">(</span>dbData <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> emails <span class="token operator">=</span> dbData<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Email</span><span class="token punctuation">&gt;</span></span> emailSet <span class="token operator">=</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span>emails<span class="token punctuation">)</span>
        	<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>value <span class="token operator">-&gt;</span> <span class="token keyword">new</span> <span class="token class-name">Email</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token function">toSet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">EmailSet</span><span class="token punctuation">(</span>emailSet<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Convert</span><span class="token punctuation">(</span>converter <span class="token operator">=</span> <span class="token class-name">EmailSetConverter</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">private</span> <span class="token class-name">EmailSet</span> emailSet<span class="token punctuation">;</span>
</code></pre></div><h3 id="_4-3-7-밸류를-이용한-id-매핑"><a href="#_4-3-7-밸류를-이용한-id-매핑" class="header-anchor">#</a> 4.3.7 밸류를 이용한 ID 매핑</h3> <ul><li>식별자라는 의미 부각을 위해 식별자를 밸류 타입으로 만들 수 있음</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Entity</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Order</span> <span class="token punctuation">{</span>
	<span class="token annotation punctuation">@EmbeddedId</span>
    <span class="token keyword">private</span> <span class="token class-name">OrderNo</span> orderNo<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
    
<span class="token annotation punctuation">@Embeddable</span>
pblic <span class="token keyword">class</span> <span class="token class-name">OrderNo</span> <span class="token keyword">implements</span> <span class="token class-name">Serializable</span> <span class="token punctuation">{</span>
	<span class="token annotation punctuation">@Column</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;order_number&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> number<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">boolean</span> is2ndGeneration <span class="token punctuation">{</span>
        <span class="token keyword">return</span> number<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">&quot;N&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>이렇게 식별자에 기능 추가 가능</li> <li>엔티티 비교로 equals(), hashcode() 값을 활용하므로 잘 구현해야 함</li></ul> <h3 id="_4-3-8-별도-테이블에-저장하는-밸류-매핑"><a href="#_4-3-8-별도-테이블에-저장하는-밸류-매핑" class="header-anchor">#</a> 4.3.8 별도 테이블에 저장하는 밸류 매핑</h3> <ul><li>애그리거트에서 루트 애그리거트를 빼면 대부분 밸류</li> <li>별도 테이블에 저장됐더라도 진짜 엔티티인지 의심해 봐야 함</li> <li>ex) Order - OrderLine</li> <li>밸류가 아니면 엔티티가 아니라 애그리거트는 아닌지 의심</li> <li>자신만의 독자적인 생명 주기를 갖는다면 애그리거트일 수 있음</li> <li>ex) Product - Review</li> <li>밸류와 엔티티 구별을 위해서 고유 식별자를 갖는지 확인
<img src="https://velog.velcdn.com/images/alstjr971/post/2cae75ee-61c7-4dd9-9247-b973f460b3e2/image.png" alt=""></li> <li>여기서 ArticleContent가 식별자가 존재한다고 1-1 연관으로 생각할 수 있지만 Article과 연결하기 위함이므로 밸류로 생각해야 함
<img src="https://velog.velcdn.com/images/alstjr971/post/7b8db9c4-a2dd-4c2a-afcb-5359b6825801/image.png" alt=""></li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Entity</span>
<span class="token annotation punctuation">@Table</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;artice&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@SecondaryTable</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;article_content&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 밸류 테이블 이름</span>
	pkJoinColumns <span class="token operator">=</span> <span class="token annotation punctuation">@PrimaryKeyJoinColumn</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">// 조인할 때 사용할 식별자</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Article</span> <span class="token punctuation">{</span>
	<span class="token annotation punctuation">@Id</span>
    <span class="token annotation punctuation">@GeneratedValue</span><span class="token punctuation">(</span><span class="token constant">IDENTITY</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> id<span class="token punctuation">;</span>
    
    <span class="token keyword">private</span> <span class="token class-name">String</span> title<span class="token punctuation">;</span>
    
    <span class="token annotation punctuation">@AttributeOverrides</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token comment">// 칼럼명 지정</span>
    	<span class="token annotation punctuation">@AttributeOverride</span><span class="token punctuation">(</span>
        	name <span class="token operator">=</span> <span class="token string">&quot;content&quot;</span><span class="token punctuation">,</span>
            column <span class="token operator">=</span> <span class="token annotation punctuation">@Column</span><span class="token punctuation">(</span>table <span class="token operator">=</span> <span class="token string">&quot;article_content&quot;</span><span class="token punctuation">,</span> name <span class="token operator">=</span> <span class="token string">&quot;content&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token annotation punctuation">@AttributeOverride</span><span class="token punctuation">(</span>
        	name <span class="token operator">=</span> <span class="token string">&quot;contentType&quot;</span><span class="token punctuation">,</span>
            column <span class="token operator">=</span> <span class="token annotation punctuation">@Column</span><span class="token punctuation">(</span>table <span class="token operator">=</span> <span class="token string">&quot;artice_content&quot;</span><span class="token punctuation">,</span> name <span class="token operator">=</span> <span class="token string">&quot;content_type&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@Embedded</span>
    <span class="token keyword">private</span> <span class="token class-name">ArticleContent</span> content<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>엔티티에 임베디드/보조테이블 여러 개 사용하려면?</p></blockquote> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Entity</span>
<span class="token annotation punctuation">@Table</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;artice&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@SecondaryTable</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;article_content&quot;</span><span class="token punctuation">,</span> pkJoinColumns <span class="token operator">=</span> <span class="token annotation punctuation">@PrimaryKeyJoinColumn</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@SecondaryTable</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;address&quot;</span><span class="token punctuation">,</span> pkJoinColumns <span class="token operator">=</span> <span class="token annotation punctuation">@PrimaryKeyJoinColumn</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Article</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Id</span>
    <span class="token annotation punctuation">@GeneratedValue</span><span class="token punctuation">(</span><span class="token constant">IDENTITY</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> id<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> title<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@AttributeOverrides</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token annotation punctuation">@AttributeOverride</span><span class="token punctuation">(</span>
            name <span class="token operator">=</span> <span class="token string">&quot;content&quot;</span><span class="token punctuation">,</span>
            column <span class="token operator">=</span> <span class="token annotation punctuation">@Column</span><span class="token punctuation">(</span>table <span class="token operator">=</span> <span class="token string">&quot;article_content&quot;</span><span class="token punctuation">,</span> name <span class="token operator">=</span> <span class="token string">&quot;content&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token annotation punctuation">@AttributeOverride</span><span class="token punctuation">(</span>
            name <span class="token operator">=</span> <span class="token string">&quot;contentType&quot;</span><span class="token punctuation">,</span>
            column <span class="token operator">=</span> <span class="token annotation punctuation">@Column</span><span class="token punctuation">(</span>table <span class="token operator">=</span> <span class="token string">&quot;article_content&quot;</span><span class="token punctuation">,</span> name <span class="token operator">=</span> <span class="token string">&quot;content_type&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@Embedded</span>
    <span class="token keyword">private</span> <span class="token class-name">ArticleContent</span> content<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@AttributeOverrides</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token annotation punctuation">@AttributeOverride</span><span class="token punctuation">(</span>
            name <span class="token operator">=</span> <span class="token string">&quot;foo&quot;</span><span class="token punctuation">,</span>
            column <span class="token operator">=</span> <span class="token annotation punctuation">@Column</span><span class="token punctuation">(</span>table <span class="token operator">=</span> <span class="token string">&quot;article_address&quot;</span><span class="token punctuation">,</span> name <span class="token operator">=</span> <span class="token string">&quot;foo&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@Embedded</span>
    <span class="token keyword">private</span> <span class="token class-name">Address</span> address<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre></div><ul><li>이 떄 필요없는 내용도 같이 조회할 수도 있는데(title만 필요한데 content도 같이 조회) 이건 조회 전용 쿼리로 해결</li></ul> <h3 id="_4-3-9-밸류-컬렉션을-entity로-매핑"><a href="#_4-3-9-밸류-컬렉션을-entity로-매핑" class="header-anchor">#</a> 4.3.9 밸류 컬렉션을 @Entity로 매핑</h3> <ul><li>밸류이지만 구현 기술의 한계나 팀 표준 때문에 @Entity를 사용해야 할 수도 있음</li> <li>밸류 타입 자체에 상속 구조(ex: Image ← InternalImage, ExternalImage)를 사용할 수 없음</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Entity</span>
<span class="token annotation punctuation">@Inheritance</span><span class="token punctuation">(</span>strategy <span class="token operator">=</span> <span class="token class-name">InheritanceType</span><span class="token punctuation">.</span><span class="token constant">SINGLE_TABLE</span><span class="token punctuation">)</span> <span class="token comment">// 한 테이블(Image)에 하위타입 모두 저장</span>
<span class="token annotation punctuation">@DiscriminatorColumn</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;image_type&quot;</span><span class="token punctuation">)</span>             <span class="token comment">// 구분자 컬럼(하위 타입 구분)</span>
<span class="token annotation punctuation">@Table</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;image&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">Image</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Entity</span>
<span class="token annotation punctuation">@DiscriminatorValue</span><span class="token punctuation">(</span><span class="token string">&quot;II&quot;</span><span class="token punctuation">)</span> <span class="token comment">// InternalImage 구분자</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">InternalImage</span> <span class="token keyword">extends</span> <span class="token class-name">Image</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Entity</span>
<span class="token annotation punctuation">@DiscriminatorValue</span><span class="token punctuation">(</span><span class="token string">&quot;EI&quot;</span><span class="token punctuation">)</span> <span class="token comment">// ExternalImage 구분자</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ExternalImage</span> <span class="token keyword">extends</span> <span class="token class-name">Image</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>근데 밸류는 불변이라 images를 바꾸려면</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">changeImages</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Image</span><span class="token punctuation">&gt;</span></span> newImages<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    images<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    images<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span>newImages<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>이러면 product에서 image들 조회 쿼리 한 번 + delete 쿼리 image 개수만큼 n 번 → 성능상 별로</li></ul> <blockquote><p>Q. 이거도 N+1 문제라 하나?</p></blockquote> <ul><li>하이버네이트는 @Embeddable 타입에 대한 컬렉션의 clear() 메서드 호출 시 단 한 번의 delete 쿼리로 삭제 처리 수행</li> <li>그래서 성능을 생각하면 다형성을 좀 포기하고 @Embeddable 쓰는게 나을 때도 있음</li></ul> <h3 id="_4-3-10-id-참조와-조인-테이블을-이용한-단방향-m-n-매핑"><a href="#_4-3-10-id-참조와-조인-테이블을-이용한-단방향-m-n-매핑" class="header-anchor">#</a> 4.3.10 ID 참조와 조인 테이블을 이용한 단방향 M-N 매핑</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Entity</span>
<span class="token annotation punctuation">@Table</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;product&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Product</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@EmbeddedId</span>
    <span class="token keyword">private</span> <span class="token class-name">ProductId</span> id<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@ElementCollection</span><span class="token punctuation">(</span>fetch <span class="token operator">=</span> <span class="token class-name">FetchType</span><span class="token punctuation">.</span><span class="token constant">LAZY</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@CollectionTable</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;product_category&quot;</span><span class="token punctuation">,</span>
            joinColumns <span class="token operator">=</span> <span class="token annotation punctuation">@JoinColumn</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;product_id&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CategoryId</span><span class="token punctuation">&gt;</span></span> categoryIds<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>Product 삭제 시 매핑에 사용한 데이터도 함께 삭제</li></ul> <h2 id="_4-4-애그리거트-로딩-전략"><a href="#_4-4-애그리거트-로딩-전략" class="header-anchor">#</a> 4.4 애그리거트 로딩 전략</h2> <ul><li>애그리거트 루트를 로딩하면 루트에 속한 모든 객체가 완전한 상태가 되어야 한다면?</li> <li>조회 방식을 즉시 로딩으로 해야 함</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@OneToMany</span><span class="token punctuation">(</span>
        cascade <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token class-name">CascadeType</span><span class="token punctuation">.</span><span class="token constant">PERSIST</span><span class="token punctuation">,</span> <span class="token class-name">CascadeType</span><span class="token punctuation">.</span><span class="token constant">REMOVE</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        orphanRemoval <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        fetch <span class="token operator">=</span> <span class="token class-name">FetchType</span><span class="token punctuation">.</span><span class="token constant">EAGER</span>
<span class="token punctuation">)</span>
<span class="token annotation punctuation">@JoinColumn</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;product_id&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@OrderColumn</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;list_idx&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Image</span><span class="token punctuation">&gt;</span></span> images <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@ElementCollection</span><span class="token punctuation">(</span>fetch <span class="token operator">=</span> <span class="token class-name">FetchType</span><span class="token punctuation">.</span><span class="token constant">EAGER</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@CollectionTable</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;product_option&quot;</span><span class="token punctuation">,</span>
        joinColumns <span class="token operator">=</span> <span class="token annotation punctuation">@JoinColumn</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;product_id&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">private</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OptionId</span><span class="token punctuation">&gt;</span></span> optionIds<span class="token punctuation">;</span>
</code></pre></div><ul><li><p>그치만 이게 항상 좋은 것은 아님</p></li> <li><p>그럼 product, image, option을 조인하는데, 중복 데이터가 많아짐</p></li> <li><p>JPA 1차 캐시에서 중복 검사 엄청 많이 하게 됨 → 성능 이슈 생김</p></li> <li><p>즉, 애그리거트는 개념적으로만 하나면 됨 → 루트 애그리거트를 로딩하는 시점에 다 가져와야 할 필요는 없음</p></li> <li><p>결국 애그리거트에 맞게 즉시 / 지연 로딩 선택해야 함</p></li></ul> <h2 id="_4-5-애그리거트의-영속성-전파"><a href="#_4-5-애그리거트의-영속성-전파" class="header-anchor">#</a> 4.5 애그리거트의 영속성 전파</h2> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@OneToMany</span><span class="token punctuation">(</span>
        cascade <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token class-name">CascadeType</span><span class="token punctuation">.</span><span class="token constant">PERSIST</span><span class="token punctuation">,</span> <span class="token class-name">CascadeType</span><span class="token punctuation">.</span><span class="token constant">REMOVE</span><span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token comment">// Product 의 저장/삭제 시 함께 저장 삭제</span>
        orphanRemoval <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span>   <span class="token comment">// images에서 Image 객체 제거 시 DB 에서도 함께 삭제</span>
        fetch <span class="token operator">=</span> <span class="token class-name">FetchType</span><span class="token punctuation">.</span><span class="token constant">LAZY</span>
<span class="token punctuation">)</span>
<span class="token annotation punctuation">@JoinColumn</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;product_id&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@OrderColumn</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;list_idx&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Image</span><span class="token punctuation">&gt;</span></span> images <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>CascadeType.ALL, orphanRemoval = True 두 옵션 모두 사용 시 부모에서 자식 생명주기 관리 가능(생성, 삭제)</li></ul> <h2 id="_4-6-식별자-생성-기능"><a href="#_4-6-식별자-생성-기능" class="header-anchor">#</a> 4.6 식별자 생성 기능</h2> <ul><li>도메인 영역에 위치 시킬 수 있음(도메인 서비스)</li> <li>리포지터리 인터페이스에 식별자 생성 메서드 추가해도 좋음</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@RequiredArgsConstructor</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WriteArticleService</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token class-name">Long</span> <span class="token function">write</span><span class="token punctuation">(</span>newArticleRequest req<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Article</span> article <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Article</span><span class="token punctuation">(</span><span class="token string">&quot;title&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ArticleContent</span><span class="token punctuation">(</span><span class="token string">&quot;content&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;type&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        articleRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>article<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> article<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 저장 이후 식별자 사용 가능</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>save의 persist는 생성된 키 바로 바인딩, merge는 새로운 객체 나오기 때문에 식별자 바인딩 안해줌</li></ul> <h2 id="_4-7-도메인-구현과-dip"><a href="#_4-7-도메인-구현과-dip" class="header-anchor">#</a> 4.7 도메인 구현과 DIP</h2> <ul><li>@Entity, @Table, ... 쓰면서 JPA 구현 기술에 의존하고 있음</li> <li>인프라에 도메인이 의존하고 있음</li></ul> <p><img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcT05mnIHWPxV47pOmEBJi6EsMJSbl0ubvf3HQ&amp;s" alt=""></p> <ul><li><p>이런식으로 구현 기술을 변경하더라도 도메인이 받는 영향을 최소화 할 수 있음</p></li> <li><p>근데 변경이 거의 없을긴데 이런더 대비하는건 좀 오바쌈바 → 타협 좀 하자</p></li> <li><p>DIP는 지키되 개발 편의성과 실용성을 가져가면서 구조적인 유연함을 어느정도 유지하자</p></li></ul></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/TIL/DomainDrivenArchitecture/3.-애그리거트.html" class="prev">
        3. 애그리거트
      </a></span> <span class="next"><a href="/TIL/DomainDrivenArchitecture/5.-스프링-데이터-JPA를-이용한-조회-기능.html">
        5. 스프링 데이터 JPA를 이용한 조회 기능
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/TIL/assets/js/app.8603dc01.js" defer></script><script src="/TIL/assets/js/2.188c950f.js" defer></script><script src="/TIL/assets/js/1.a1e51968.js" defer></script><script src="/TIL/assets/js/47.899377b1.js" defer></script>
  </body>
</html>
