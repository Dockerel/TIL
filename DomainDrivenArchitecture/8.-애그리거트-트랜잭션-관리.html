<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>8. 애그리거트 트랜잭션 관리 | Today Dockerel Learned</title>
    <meta name="generator" content="VuePress 1.9.10">
    <link rel="icon" href="/TIL/logo.png">
    <meta name="description" content="Dockerel&#39;s Personal Wiki (Today I Learned)">
    
    <link rel="preload" href="/TIL/assets/css/0.styles.40dd5a95.css" as="style"><link rel="preload" href="/TIL/assets/js/app.37b1fd22.js" as="script"><link rel="preload" href="/TIL/assets/js/2.188c950f.js" as="script"><link rel="preload" href="/TIL/assets/js/1.a1e51968.js" as="script"><link rel="preload" href="/TIL/assets/js/54.378d3bf4.js" as="script"><link rel="prefetch" href="/TIL/assets/js/10.e6f03b60.js"><link rel="prefetch" href="/TIL/assets/js/11.0fba4bf3.js"><link rel="prefetch" href="/TIL/assets/js/12.181bd7bc.js"><link rel="prefetch" href="/TIL/assets/js/13.c5707e1c.js"><link rel="prefetch" href="/TIL/assets/js/14.b086a433.js"><link rel="prefetch" href="/TIL/assets/js/15.3e75d743.js"><link rel="prefetch" href="/TIL/assets/js/16.a2bc07a8.js"><link rel="prefetch" href="/TIL/assets/js/17.ce3d5b6e.js"><link rel="prefetch" href="/TIL/assets/js/18.c240daa0.js"><link rel="prefetch" href="/TIL/assets/js/19.60958448.js"><link rel="prefetch" href="/TIL/assets/js/20.4352d5d9.js"><link rel="prefetch" href="/TIL/assets/js/21.8fb87d52.js"><link rel="prefetch" href="/TIL/assets/js/22.664a6cc8.js"><link rel="prefetch" href="/TIL/assets/js/23.5ae71a00.js"><link rel="prefetch" href="/TIL/assets/js/24.df2a0383.js"><link rel="prefetch" href="/TIL/assets/js/25.1aeaac43.js"><link rel="prefetch" href="/TIL/assets/js/26.eb265b20.js"><link rel="prefetch" href="/TIL/assets/js/27.41f28bb0.js"><link rel="prefetch" href="/TIL/assets/js/28.37ba8758.js"><link rel="prefetch" href="/TIL/assets/js/29.37158e46.js"><link rel="prefetch" href="/TIL/assets/js/3.e9de9cb1.js"><link rel="prefetch" href="/TIL/assets/js/30.e43ecaae.js"><link rel="prefetch" href="/TIL/assets/js/31.39ce7d2d.js"><link rel="prefetch" href="/TIL/assets/js/32.5fd280ec.js"><link rel="prefetch" href="/TIL/assets/js/33.5464c717.js"><link rel="prefetch" href="/TIL/assets/js/34.03a9f39d.js"><link rel="prefetch" href="/TIL/assets/js/35.bd335bb3.js"><link rel="prefetch" href="/TIL/assets/js/36.7c2d0c6f.js"><link rel="prefetch" href="/TIL/assets/js/37.90b10f8f.js"><link rel="prefetch" href="/TIL/assets/js/38.18b66ba6.js"><link rel="prefetch" href="/TIL/assets/js/39.0f5cd554.js"><link rel="prefetch" href="/TIL/assets/js/4.c5b6f970.js"><link rel="prefetch" href="/TIL/assets/js/40.00a51514.js"><link rel="prefetch" href="/TIL/assets/js/41.7d0a7554.js"><link rel="prefetch" href="/TIL/assets/js/42.9afe14b6.js"><link rel="prefetch" href="/TIL/assets/js/43.724770cd.js"><link rel="prefetch" href="/TIL/assets/js/44.2adb638a.js"><link rel="prefetch" href="/TIL/assets/js/45.d63da8b9.js"><link rel="prefetch" href="/TIL/assets/js/46.b69bd46b.js"><link rel="prefetch" href="/TIL/assets/js/47.e1ee2a1a.js"><link rel="prefetch" href="/TIL/assets/js/48.de028b34.js"><link rel="prefetch" href="/TIL/assets/js/49.1afdf71d.js"><link rel="prefetch" href="/TIL/assets/js/5.5e20f558.js"><link rel="prefetch" href="/TIL/assets/js/50.77bc39d9.js"><link rel="prefetch" href="/TIL/assets/js/51.ac3c70be.js"><link rel="prefetch" href="/TIL/assets/js/52.d7e88570.js"><link rel="prefetch" href="/TIL/assets/js/53.3cafc1c0.js"><link rel="prefetch" href="/TIL/assets/js/55.f3ad0b4d.js"><link rel="prefetch" href="/TIL/assets/js/56.31674b5b.js"><link rel="prefetch" href="/TIL/assets/js/57.44dc5c05.js"><link rel="prefetch" href="/TIL/assets/js/58.a01582ba.js"><link rel="prefetch" href="/TIL/assets/js/59.2b2e1bfd.js"><link rel="prefetch" href="/TIL/assets/js/6.e8a6e3a8.js"><link rel="prefetch" href="/TIL/assets/js/60.b7a6cd2d.js"><link rel="prefetch" href="/TIL/assets/js/61.651dfcc4.js"><link rel="prefetch" href="/TIL/assets/js/62.e097350c.js"><link rel="prefetch" href="/TIL/assets/js/63.6845d699.js"><link rel="prefetch" href="/TIL/assets/js/64.c8934f45.js"><link rel="prefetch" href="/TIL/assets/js/65.cce0c2b8.js"><link rel="prefetch" href="/TIL/assets/js/66.01b06e2e.js"><link rel="prefetch" href="/TIL/assets/js/67.b6640c60.js"><link rel="prefetch" href="/TIL/assets/js/68.c5e5e480.js"><link rel="prefetch" href="/TIL/assets/js/69.5d2e20a7.js"><link rel="prefetch" href="/TIL/assets/js/7.7fea5211.js"><link rel="prefetch" href="/TIL/assets/js/70.b9555da5.js"><link rel="prefetch" href="/TIL/assets/js/71.bed4b1e7.js"><link rel="prefetch" href="/TIL/assets/js/72.d8285789.js"><link rel="prefetch" href="/TIL/assets/js/vendors~docsearch.68e379d9.js">
    <link rel="stylesheet" href="/TIL/assets/css/0.styles.40dd5a95.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/TIL/" class="home-link router-link-active"><!----> <span class="site-name">Today Dockerel Learned</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="https://github.com/Dockerel/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://dockerel.tistory.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Blog
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="https://github.com/Dockerel/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://dockerel.tistory.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Blog
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Backend</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>DomainDrivenArchitecture</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/TIL/DomainDrivenArchitecture/1.-도메인-모델-시작하기.html" class="sidebar-link">1. 도메인 모델 시작하기</a></li><li><a href="/TIL/DomainDrivenArchitecture/2.-아키텍처-개요.html" class="sidebar-link">2. 아키텍처 개요</a></li><li><a href="/TIL/DomainDrivenArchitecture/3.-애그리거트.html" class="sidebar-link">3. 애그리거트</a></li><li><a href="/TIL/DomainDrivenArchitecture/4.-리포지터리와-모델-구현.html" class="sidebar-link">4. 리포지터리와 모델 구현</a></li><li><a href="/TIL/DomainDrivenArchitecture/5.-스프링-데이터-JPA를-이용한-조회-기능.html" class="sidebar-link">5. 스프링 데이터 JPA를 이용한 조회 기능</a></li><li><a href="/TIL/DomainDrivenArchitecture/6.-응용-서비스와-표현-영역.html" class="sidebar-link">6. 응용 서비스와 표현 영역</a></li><li><a href="/TIL/DomainDrivenArchitecture/7.-도메인-서비스.html" class="sidebar-link">7. 도메인 서비스</a></li><li><a href="/TIL/DomainDrivenArchitecture/8.-애그리거트-트랜잭션-관리.html" class="active sidebar-link">8. 애그리거트 트랜잭션 관리</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/TIL/DomainDrivenArchitecture/8.-애그리거트-트랜잭션-관리.html#_8-1-애그리거트와-트랜잭션" class="sidebar-link">8.1 애그리거트와 트랜잭션</a></li><li class="sidebar-sub-header"><a href="/TIL/DomainDrivenArchitecture/8.-애그리거트-트랜잭션-관리.html#_8-2-선점-잠금" class="sidebar-link">8.2 선점 잠금</a></li><li class="sidebar-sub-header"><a href="/TIL/DomainDrivenArchitecture/8.-애그리거트-트랜잭션-관리.html#_8-3-비선점-잠금" class="sidebar-link">8.3 비선점 잠금</a></li><li class="sidebar-sub-header"><a href="/TIL/DomainDrivenArchitecture/8.-애그리거트-트랜잭션-관리.html#_8-4-오프라인-선점-잠금" class="sidebar-link">8.4 오프라인 선점 잠금</a></li></ul></li><li><a href="/TIL/DomainDrivenArchitecture/9.-도메인-모델과-경계.html" class="sidebar-link">9. 도메인 모델과 경계</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Java</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>OperatingSystem</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>PS</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Kubernetes</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="_8-애그리거트-트랜잭션-관리"><a href="#_8-애그리거트-트랜잭션-관리" class="header-anchor">#</a> 8. 애그리거트 트랜잭션 관리</h1> <h2 id="_8-1-애그리거트와-트랜잭션"><a href="#_8-1-애그리거트와-트랜잭션" class="header-anchor">#</a> 8.1 애그리거트와 트랜잭션</h2> <p><img src="https://img1.daumcdn.net/thumb/R800x0/?scode=mtistory2&amp;fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdna%2FbSZsx8%2FbtrHfR1nqBa%2FAAAAAAAAAAAAAAAAAAAAAJ4rlxWzzFewrDoclOaD_olpIk0X-MtG5DG3F1ebZoyI%2Fimg.png%3Fcredential%3DyqXZFxpELC7KVnFOS48ylbz2pIh7yKj8%26expires%3D1753973999%26allow_ip%3D%26allow_referer%3D%26signature%3DavNYAU5nzvy8LPVcsuDQaOF2twA%253D" alt=""></p> <p>위와 같은 경우는 추가적인 트랜잭션 처리 기법(선점 잠금 : 비관적 락, 비선점 잠금 : 낙관적 락)으로 해결 가능</p> <h2 id="_8-2-선점-잠금"><a href="#_8-2-선점-잠금" class="header-anchor">#</a> 8.2 선점 잠금</h2> <ul><li>비관적 락</li> <li>먼저 애그리거트를 구한 스레드가 애그리거트 사용이 끝날 때까지 다른 스레드가 해당 애그리거트를 수정하지 못하게 막는 방식
<img src="https://kjgleh.github.io/asset/images/ddd/ddd_start_08_03.PNG" alt=""></li> <li>잠금 해제시까지 스레드2가 블로킹 됨 (블로킹 : 스레드2가 스레드1이 락을 반환하기 전까지 대기)</li> <li>보통 DBMS가 제공하는 행단위 잠금 사용</li> <li>ex) <code>for update</code> 쿼리</li> <li>스프링에서는?</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Lock</span><span class="token punctuation">(</span><span class="token class-name">LockModeType</span><span class="token punctuation">.</span><span class="token constant">PESSIMISTIC_WRITE</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Query</span><span class="token punctuation">(</span><span class="token string">&quot;select e from EventWithLock e where e.id = :id&quot;</span><span class="token punctuation">)</span>
<span class="token class-name">Optional</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">EventWithLock</span><span class="token punctuation">&gt;</span></span> <span class="token function">findByIdWithPessimisticLock</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Transactional</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">joinEventPessimistic</span><span class="token punctuation">(</span><span class="token class-name">Long</span> eventId<span class="token punctuation">,</span> <span class="token class-name">Long</span> memberId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">EventWithLock</span> event <span class="token operator">=</span> eventRepository<span class="token punctuation">.</span><span class="token function">findByIdWithPessimisticLock</span><span class="token punctuation">(</span>eventId<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">orElseThrow</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token keyword">new</span> <span class="token class-name">EntityNotFoundException</span><span class="token punctuation">(</span><span class="token string">&quot;이벤트를 찾을 수 없습니다.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Member</span> member <span class="token operator">=</span> memberRepository<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>memberId<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">orElseThrow</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token keyword">new</span> <span class="token class-name">EntityNotFoundException</span><span class="token punctuation">(</span><span class="token string">&quot;회원을 찾을 수 없습니다.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    event<span class="token punctuation">.</span><span class="token function">increaseParticipants</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name">EventWithLockParticipant</span> participant <span class="token operator">=</span> <span class="token class-name">EventWithLockParticipant</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">event</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">member</span><span class="token punctuation">(</span>member<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    participantRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>participant<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>트랜잭션이 끝나고 커밋되면서 락도 반환됨</li></ul> <h3 id="_8-2-1-선점-잠금과-교착-상태"><a href="#_8-2-1-선점-잠금과-교착-상태" class="header-anchor">#</a> 8.2.1 선점 잠금과 교착 상태</h3> <ul><li>잠금 순서에 따른 교착 상태가 발생하지 않도록 주의해야 함</li> <li>교착 상태를 방지하지 위해 잠금을 구할 때 최대 대기 시간을 지정해야 함</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> hints <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
hints<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;jakarta.persistence.lock.timeout&quot;</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
entityManager<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token class-name">Member</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> memberId<span class="token punctuation">,</span> <span class="token class-name">LockModeType</span><span class="token punctuation">.</span><span class="token constant">PESSIMISTIC_WRITE</span><span class="token punctuation">,</span> hints<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>위와 같은 방식으로 해결 가능</li> <li>Spring Data JPA 로는</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Lock</span><span class="token punctuation">(</span><span class="token class-name">LockModeType</span><span class="token punctuation">.</span><span class="token constant">PESSIMISTIC_WRITE</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@QueryHints</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token annotation punctuation">@QueryHint</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;jakarta.persistence.lock.timeout&quot;</span><span class="token punctuation">,</span> value <span class="token operator">=</span> <span class="token string">&quot;2000&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Query</span><span class="token punctuation">(</span><span class="token string">&quot;select m from Product p where p.id = :id&quot;</span><span class="token punctuation">)</span>
<span class="token class-name">Optional</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Product</span><span class="token punctuation">&gt;</span></span> <span class="token function">findProductForUpdate</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Param</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span> <span class="token class-name">ProductId</span> productId<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="_8-3-비선점-잠금"><a href="#_8-3-비선점-잠금" class="header-anchor">#</a> 8.3 비선점 잠금</h2> <p><img src="https://velog.velcdn.com/images/guns95/post/8eff5fee-94dd-405f-b2fd-539194661eab/image.png" alt=""></p> <ul><li><p>이런 경우에는 비관적 락으로 해결 불가능</p></li> <li><p>비선점 잠금(낙관적 락)으로 해결 가능</p></li> <li><p>애그리거트에 버전으로 사용할 숫자 타입 프로퍼티 추가</p></li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token constant">UPDATE</span> aggtable <span class="token class-name">SET</span> version <span class="token operator">=</span> version <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span> colx<span class="token operator">=</span> <span class="token operator">?</span><span class="token punctuation">,</span> coly <span class="token operator">=</span> <span class="token operator">?</span>
<span class="token class-name">WHERE</span> aggid <span class="token operator">=</span> <span class="token operator">?</span> and version <span class="token operator">=</span> 현재버전
</code></pre></div><ul><li>위 쿼리와 같이 애그리거트 수정할 때마다 버전으로 사용한 프로퍼티 값이 1씩 증가
<img src="https://velog.velcdn.com/images/guns95/post/de36add1-335f-4e56-a896-eeb8ef7986e2/image.png" alt=""></li> <li>처음 조회한 버전과 다를 시(5!=6) 예외 발생</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Entity</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Stock</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Id</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> id<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Version</span>
    <span class="token keyword">private</span> <span class="token class-name">Long</span> version<span class="token punctuation">;</span>

    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre></div><ul><li>@Version 어노테이션 사용
<img src="https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&amp;fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdna%2FxIlvZ%2FbtsaEhjc2Mn%2FAAAAAAAAAAAAAAAAAAAAANJQ3PCj63waYUF17HONKfxRGXUjEth71Fcuk47eZO6E%2Fimg.png%3Fcredential%3DyqXZFxpELC7KVnFOS48ylbz2pIh7yKj8%26expires%3D1756652399%26allow_ip%3D%26allow_referer%3D%26signature%3D41jQ2yexv92nsuwrH0HFWELrk6M%253D" alt=""></li> <li>위 사진과 같이 버전값을 같이 보내주어 데이터의 변경 여부 확인(조회와 수정 트랜잭션이 분리되어 있기 때문에)</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Transactional</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">startShipping</span><span class="token punctuation">(</span><span class="token class-name">StartShippingRequest</span> req<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Order</span> order <span class="token operator">=</span> orderRepository<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">OrderNo</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span><span class="token function">getOrderNumber</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">checkOrder</span><span class="token punctuation">(</span>order<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>order<span class="token punctuation">.</span><span class="token function">matchVersion</span><span class="token punctuation">(</span>req<span class="token punctuation">.</span>getVersion<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">VersionConflictException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    order<span class="token punctuation">.</span><span class="token function">startShipping</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_8-3-1-강제-버전-증가"><a href="#_8-3-1-강제-버전-증가" class="header-anchor">#</a> 8.3.1 강제 버전 증가</h3> <ul><li>애그리거트의 루트가 아닌 다른 엔티티가 수정되었을 때 버전이 증가되어야 하지만 실제로는 증가 안됨</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Repository</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JpaOrderRepository</span> <span class="token keyword">implements</span> <span class="token class-name">OrderRepository</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@PersistenceContext</span>
    <span class="token keyword">private</span> <span class="token class-name">EntityManager</span> entityManager<span class="token punctuation">;</span>
    
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Order</span> <span class="token function">findByIdOptimisticLockMode</span><span class="token punctuation">(</span><span class="token class-name">OrderNo</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> entityManager<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token class-name">Order</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> id<span class="token punctuation">,</span> <span class="token class-name">LockModeType</span><span class="token punctuation">.</span><span class="token constant">OPTIMISTIC_FORCE_INCREMENT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>위와 같은 방식으로 트랜잭션 종료 시점에 강제 버전 증가 가능</li></ul> <h2 id="_8-4-오프라인-선점-잠금"><a href="#_8-4-오프라인-선점-잠금" class="header-anchor">#</a> 8.4 오프라인 선점 잠금</h2> <p><img src="https://leejaedoo.github.io/assets/img/offline_lock.jpg" alt=""></p> <ul><li>여러 트랜잭션에 걸쳐 동시 변경을 막음</li> <li>잠금 유효방식을 가져야 함. 그래야 무한 잠금이 방지됨</li> <li>ex) 수정 폼에서 1분단위로 잠금 유효시간 연장 요청 보내기</li> <li>직접 manual 하게 구현</li></ul> <h3 id="_8-4-2-db를-이용한-lockmanager-구현"><a href="#_8-4-2-db를-이용한-lockmanager-구현" class="header-anchor">#</a> 8.4.2 DB를 이용한 LockManager 구현</h3> <p>...</p> <p>→ 근데 이렇게 할바엔 더 빨리 조회가능하고 TTL을 사용할 수 있는 레디스 기반 네임드 락 사용하는게 나을듯</p> <ul><li>지금은 RDB 기반으로 조회, 삽입, 수정 쿼리를 직접 넣고 있고, TTL이 없기 때문에 expiration date를 직접 지정해서 관리하고 있는데, 레디스 기반 네임드락 사용 시 인메모리 기반 db기 때문에 그리고 key-value 기반 해시 구조로 더 빨리 조회 가능, 그리고 TTL로 expiration date 간단하게 관리가능.</li></ul> <h3 id="레디스는-싱글-스레드-기반인데-더-빠른-이유"><a href="#레디스는-싱글-스레드-기반인데-더-빠른-이유" class="header-anchor">#</a> 레디스는 싱글 스레드 기반인데 더 빠른 이유?</h3> <ol><li>인메모리 데이터 구조로 모든 연산이 렘에서 일어나서 디스크 io 대기 시간이 없음</li> <li>싱글 스레드 기반이기 때문에 락 경합, 컨텍스트 스위칭 오버헤드가 없음</li> <li>io 멀티플렉싱 : 파이프라이닝 그리고 lua 스크립트 등의 방식으로 rtt 오버헤드가 감소</li></ol></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/TIL/DomainDrivenArchitecture/7.-도메인-서비스.html" class="prev">
        7. 도메인 서비스
      </a></span> <span class="next"><a href="/TIL/DomainDrivenArchitecture/9.-도메인-모델과-경계.html">
        9. 도메인 모델과 경계
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/TIL/assets/js/app.37b1fd22.js" defer></script><script src="/TIL/assets/js/2.188c950f.js" defer></script><script src="/TIL/assets/js/1.a1e51968.js" defer></script><script src="/TIL/assets/js/54.378d3bf4.js" defer></script>
  </body>
</html>
